<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI-EVA - æ™ºèƒ½è™šæ‹Ÿä¼´ä¾£</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@pixiv/three-vrm@1.0.7/lib/three-vrm.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #1a202c;
      line-height: 1.6;
      overflow: hidden;
      height: 100vh;
    }

    .app-container {
      display: flex;
      height: 100vh;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      margin: 10px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
      overflow: hidden;
    }
    
    .control-panel {
      width: 320px;
      background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
      border-right: 1px solid rgba(226, 232, 240, 0.8);
      padding: 24px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: #cbd5e0 transparent;
      z-index: 1000;
      position: relative;
      flex-shrink: 0;
    }
    
    .control-panel::-webkit-scrollbar {
      width: 6px;
    }
    
    .control-panel::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .control-panel::-webkit-scrollbar-thumb {
      background: #cbd5e0;
      border-radius: 3px;
    }
    
    .main-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #ffffff;
      min-width: 0;
      overflow: hidden;
    }
    
    .scene-container {
      flex: 1;
      position: relative;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      overflow: hidden;
      min-height: 300px;
    }
    
    #vrm-viewer {
      width: 100%;
      height: 100%;
      display: block;
    }
    
    .chat-area {
      height: 200px;
      background: #ffffff;
      border-top: 1px solid rgba(226, 232, 240, 0.8);
      display: flex;
      flex-direction: column;
      backdrop-filter: blur(10px);
      z-index: 10;
      position: relative;
      flex-shrink: 0;
    }
    
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      scrollbar-width: thin;
      scrollbar-color: #cbd5e0 transparent;
    }
    
    .chat-messages::-webkit-scrollbar {
      width: 6px;
    }
    
    .chat-messages::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .chat-messages::-webkit-scrollbar-thumb {
      background: #cbd5e0;
      border-radius: 3px;
    }
    
    .chat-input-area {
      display: flex;
      padding: 16px;
      background: #f8fafc;
      border-top: 1px solid rgba(226, 232, 240, 0.8);
      gap: 12px;
    }
    
    .chat-input {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 14px;
      background: #ffffff;
      transition: all 0.2s ease;
      outline: none;
    }
    
    .chat-input:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .btn-primary {
      padding: 12px 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .btn-secondary:hover {
      box-shadow: 0 4px 12px rgba(240, 147, 251, 0.3);
    }
    
    .control-section {
      margin-bottom: 24px;
      background: #ffffff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      border: 1px solid rgba(226, 232, 240, 0.6);
    }
    
    .control-section h3 {
      margin: 0 0 12px 0;
      font-size: 14px;
      font-weight: 600;
      color: #2d3748;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .control-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .control-buttons button {
      padding: 8px 12px;
      border: 1px solid #e2e8f0;
      background: #ffffff;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      color: #4a5568;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 4px;
      flex: 1;
      min-width: 120px;
      justify-content: center;
    }
    
    .control-buttons button:hover {
      background: #f7fafc;
      border-color: #cbd5e0;
      transform: translateY(-1px);
    }
    
    .control-buttons button.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: transparent;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }
    
    #voice-settings .control-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    
    #voice-settings .control-buttons button {
      flex: none;
      min-width: auto;
    }
    
    @media (max-width: 768px) {
      #voice-settings .control-buttons {
        grid-template-columns: 1fr;
        gap: 6px;
      }
    }
    
    .slider-container {
      margin: 12px 0;
    }
    
    .slider-container label {
      display: block;
      margin-bottom: 6px;
      font-size: 12px;
      font-weight: 500;
      color: #4a5568;
    }
    
    .slider-container input[type="range"] {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: #e2e8f0;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }
    
    .slider-container input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
    }
    
    .slider-container .value {
      font-size: 11px;
      color: #718096;
      margin-left: 8px;
      font-weight: 500;
    }
    
    .file-input-container {
      margin: 12px 0;
    }
    
    .file-input-container input[type="file"] {
      width: 100%;
      padding: 8px 12px;
      border: 2px dashed #cbd5e0;
      border-radius: 8px;
      background: #f8fafc;
      font-size: 12px;
      color: #4a5568;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .file-input-container input[type="file"]:hover {
      border-color: #667eea;
      background: #f0f4ff;
    }
    
    .status {
      font-size: 11px;
      color: #718096;
      margin-top: 8px;
      padding: 6px 8px;
      background: #f7fafc;
      border-radius: 6px;
      border-left: 3px solid #667eea;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .status-indicator {
      font-size: 8px;
      animation: pulse 2s infinite;
    }
    
    .status-indicator.connected {
      color: #10b981;
      animation: none;
    }
    
    .status-indicator.connecting {
      color: #f59e0b;
    }
    
    .status-indicator.disconnected {
      color: #ef4444;
      animation: none;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .message-container {
      display: flex;
      margin-bottom: 16px;
      animation: messageSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    @keyframes messageSlideIn {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    .message-bubble {
      max-width: 75%;
      padding: 12px 16px;
      border-radius: 18px;
      word-wrap: break-word;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      line-height: 1.5;
      font-size: 14px;
      font-weight: 400;
    }
    
    .user-message {
      justify-content: flex-end;
    }
    
    .user-message .message-bubble {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-bottom-right-radius: 6px;
      margin-left: auto;
    }
    
    .ai-message {
      justify-content: flex-start;
    }
    
    .ai-message .message-bubble {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      border-bottom-left-radius: 6px;
      margin-right: auto;
    }
    
    .system-message {
      justify-content: center;
    }
    
    .system-message .message-bubble {
      background: rgba(251, 191, 36, 0.1);
      color: #d69e2e;
      border: 1px solid rgba(251, 191, 36, 0.2);
      font-size: 12px;
      padding: 8px 12px;
      max-width: 85%;
      font-weight: 500;
    }
    
    .fade-in {
      animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
        max-height: 0;
      }
      to {
        opacity: 1;
        transform: translateY(0);
        max-height: 100px;
      }
    }
    
    @keyframes slideUp {
      from {
        opacity: 1;
        transform: translateY(0);
        max-height: 100px;
      }
      to {
        opacity: 0;
        transform: translateY(-10px);
        max-height: 0;
      }
    }
    
    #typing-cursor {
      animation: blink 1.2s infinite;
      font-weight: bold;
    }
    
    @keyframes blink {
      0%, 49% { opacity: 1; }
      50%, 100% { opacity: 0; }
    }
    
    .loading-overlay {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 50;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      color: white;
      backdrop-filter: blur(10px);
    }
    
    .loading-spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .drop-zone-active {
      border: 2px dashed #667eea !important;
      background-color: rgba(102, 126, 234, 0.1) !important;
    }
    
    
    @media (min-width: 1200px) {
      .app-container {
        flex-direction: row;
      }
      
      .control-panel {
        width: 350px;
        flex-shrink: 0;
      }
      
      .main-area {
        flex: 1;
        min-width: 0;
      }
      
      .chat-area {
        height: 220px;
      }
      
      .scene-container {
        flex: 1;
        min-height: 400px;
      }
    }
    
    @media (max-width: 1199px) and (min-width: 769px) {
      .app-container {
        flex-direction: row;
        margin: 8px;
      }
      
      .control-panel {
        width: 300px;
        flex-shrink: 0;
        padding: 20px;
      }
      
      .main-area {
        flex: 1;
        min-width: 0;
      }
      
      .chat-area {
        height: 180px;
      }
      
      .scene-container {
        flex: 1;
        min-height: 350px;
      }
    }
    
    @media (max-width: 768px) {
      .app-container {
        flex-direction: column;
        margin: 5px;
        border-radius: 15px;
        height: calc(100vh - 10px);
      }
      
      .control-panel {
        width: 100%;
        height: auto;
        max-height: 40vh;
        border-right: none;
        border-bottom: 1px solid rgba(226, 232, 240, 0.8);
        padding: 16px;
        flex-shrink: 0;
      }
      
      .main-area {
        flex: 1;
        min-height: 0;
        display: flex;
        flex-direction: column;
      }
      
      .scene-container {
        flex: 1;
        min-height: 250px;
      }
      
      .chat-area {
        height: 180px;
        flex-shrink: 0;
      }
    }
    
    @media (max-width: 480px) {
      .app-container {
        margin: 2px;
        border-radius: 10px;
        height: calc(100vh - 4px);
      }
      
      .control-panel {
        padding: 12px;
        max-height: 35vh;
      }
      
      .control-section {
        margin-bottom: 16px;
        padding: 12px;
      }
      
      .control-section h3 {
        font-size: 13px;
      }
      
      .control-buttons {
        flex-direction: column;
        gap: 6px;
      }
      
      .control-buttons button {
        padding: 8px 12px;
        font-size: 12px;
        min-width: auto;
        flex: none;
      }
      
      .chat-area {
        height: 160px;
      }
      
      .scene-container {
        min-height: 200px;
      }
    }
    
    .mobile-only {
      display: none !important;
    }
    
    @media (max-width: 768px) {
      .mobile-only {
        display: flex !important;
      }
      
      .control-panel.hidden {
        display: none;
      }
      
      .control-panel {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 2000;
        background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }
      
      .control-panel.show {
        display: block;
        animation: slideInFromTop 0.3s ease-out;
      }
      
      .control-panel.hide {
        animation: slideOutToTop 0.3s ease-in;
      }
      
      @keyframes slideInFromTop {
        from {
          transform: translateY(-100%);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
      
      @keyframes slideOutToTop {
        from {
          transform: translateY(0);
          opacity: 1;
        }
        to {
          transform: translateY(-100%);
          opacity: 0;
        }
      }
    }
    
    @media (prefers-color-scheme: dark) {
      body {
        background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
      }
      
      .app-container {
        background: rgba(26, 32, 44, 0.95);
        color: #e2e8f0;
      }
      
      .control-panel {
        background: linear-gradient(180deg, #2d3748 0%, #1a202c 100%);
        border-right-color: rgba(74, 85, 104, 0.3);
      }
      
      .main-area {
        background: #1a202c;
      }
      
      .chat-area {
        background: #1a202c;
        border-top-color: rgba(74, 85, 104, 0.3);
      }
      
      .chat-input-area {
        background: #2d3748;
        border-top-color: rgba(74, 85, 104, 0.3);
      }
      
      .chat-input {
        background: #2d3748;
        border-color: #4a5568;
        color: #e2e8f0;
      }
      
      .chat-input:focus {
        border-color: #667eea;
      }
      
      .control-section {
        background: #2d3748;
        border-color: rgba(74, 85, 104, 0.3);
      }
      
      .control-section h3 {
        color: #e2e8f0;
      }
      
      .control-buttons button {
        background: #2d3748;
        border-color: #4a5568;
        color: #e2e8f0;
      }
      
      .control-buttons button:hover {
        background: #4a5568;
      }
    }
    
    .hidden { display: none; }
    .text-center { text-align: center; }
    .text-sm { font-size: 12px; }
    .text-xs { font-size: 11px; }
    .font-medium { font-weight: 500; }
    .font-semibold { font-weight: 600; }
    .opacity-50 { opacity: 0.5; }
    .opacity-75 { opacity: 0.75; }
    
    #voice-indicator { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 20px; border-radius: 10px; z-index: 100; display: none; }
    .pulse { animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    
    .control-group { 
      margin-bottom: 20px; 
      padding: 15px; 
      border: 1px solid #e5e7eb; 
      border-radius: 10px; 
      background: rgba(255,255,255,0.5);
    }
    .control-group h3 { 
      margin-bottom: 15px; 
      padding-bottom: 8px; 
      border-bottom: 2px solid #EC4899; 
      color: #4f46e5; 
    }
    .control-buttons { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 10px; 
      margin-bottom: 15px;
    }
    .control-buttons button { 
      flex: 1; 
      min-width: 120px; 
      padding: 10px; 
      border-radius: 8px; 
      color: white; 
      border: none; 
      cursor: pointer; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      gap: 5px;
    }
    
    .suggestion-btn {
      display: inline-block;
      margin: 2px;
      padding: 5px 10px;
      background: #3b82f6;
      color: white;
      border-radius: 15px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }
    .suggestion-btn:hover {
      background: #2563eb;
      transform: scale(1.05);
    }
    
    .keyword-highlight {
      background: #fef3c7;
      padding: 2px 4px;
      border-radius: 3px;
      font-weight: bold;
    }
    
    .emotion-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      margin-left: 5px;
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .message-container {
      display: flex;
      margin-bottom: 12px;
      animation: messageSlideIn 0.3s ease-out;
    }
    
    @keyframes messageSlideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .message-bubble {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 12px;
      word-wrap: break-word;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      line-height: 1.6;
      font-size: 15px;
    }
    
    .user-message {
      justify-content: flex-end;
    }
    
    .user-message .message-bubble {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-bottom-right-radius: 4px;
      margin-left: auto;
    }
    
    .ai-message {
      justify-content: flex-start;
    }
    
    .ai-message .message-bubble {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      border-bottom-left-radius: 4px;
      margin-right: auto;
    }
    
    .system-message {
      justify-content: center;
    }
    
    .system-message .message-bubble {
      background: rgba(251, 191, 36, 0.2);
      color: #92400e;
      border: 1px solid rgba(251, 191, 36, 0.3);
      font-size: 13px;
      padding: 8px 12px;
      max-width: 90%;
    }
    
    @media (prefers-color-scheme: dark) {
      .user-message .message-bubble {
        background: linear-gradient(135deg, #4c51bf 0%, #553c9a 100%);
      }
      
      .ai-message .message-bubble {
        background: linear-gradient(135deg, #ec4899 0%, #ef4444 100%);
      }
      
      .system-message .message-bubble {
        background: rgba(251, 191, 36, 0.15);
        color: #fbbf24;
        border-color: rgba(251, 191, 36, 0.25);
      }
      
      .message-bubble {
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      }
    }
    
    .message-timestamp {
      font-size: 11px;
      opacity: 0.7;
      margin-top: 4px;
      text-align: right;
    }
    
    #typing-cursor {
      animation: blink 1s infinite;
      font-weight: bold;
    }
    
    @keyframes blink {
      0%, 49% { opacity: 1; }
      50%, 100% { opacity: 0; }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
    <div class="control-panel">
      <div class="control-section">
        <h3>
          <span class="material-icons-round">settings</span>
          ç³»ç»Ÿè®¾ç½®
        </h3>
        <div class="control-buttons">
          <button id="open-settings" class="active">
            <span class="material-icons-round">tune</span>
            è®¾ç½®é¢æ¿
          </button>
          <button id="share-btn" title="åˆ†äº«">
            <span class="material-icons-round">share</span>
            åˆ†äº«
          </button>
          <button id="toggle-control-panel" class="mobile-only" title="åˆ‡æ¢æ§åˆ¶é¢æ¿">
            <span class="material-icons-round">menu</span>
            åˆ‡æ¢é¢æ¿
          </button>
  </div>
        <div class="status" id="connection-status">ç³»ç»Ÿå·²è¿æ¥</div>
      </div>
      
      <div class="control-section" id="ai-model-section">
        <h3>
          <span class="material-icons-round">smart_toy</span>
          AI æ¨¡å‹
        </h3>
        <div class="slider-container" id="model-selector" style="display: none;">
          <label>Ollama æ¨¡å‹:</label>
          <div style="display: flex; gap: 8px; align-items: center;">
            <select id="ollama-model" class="chat-input" style="flex: 1;">
              <option value="">æ­£åœ¨åŠ è½½æ¨¡å‹...</option>
            </select>
            <button id="refresh-models" class="btn-primary" style="padding: 8px; font-size: 12px;" title="åˆ·æ–°æ¨¡å‹åˆ—è¡¨">
              <span class="material-icons-round">refresh</span>
            </button>
          </div>
        </div>
        <div class="status" id="ollama-status">
          <span class="status-indicator" id="ollama-indicator">â—</span>
          <span id="ollama-text">Ollama æœªè¿æ¥</span>
        </div>
      </div>
      
      <div class="control-section" id="voice-settings">
        <h3>
          <span class="material-icons-round">record_voice_over</span>
          è¯­éŸ³è®¾ç½®
        </h3>
        <div class="control-buttons">
          <button id="toggle-voice" class="active">
            <span class="material-icons-round">mic</span>
            è¯­éŸ³è¾“å…¥
          </button>
          <button id="toggle-sensevoice">
            <span class="material-icons-round">record_voice_over</span>
            è¯­éŸ³è¯†åˆ«
          </button>
        </div>
        <div class="slider-container">
          <label>è¯­é€Ÿ: <span class="value" id="tts-speed-value">1.0x</span></label>
          <input type="range" id="tts-speed" min="0.5" max="2.0" step="0.1" value="1.0">
        </div>
        <div class="status" id="tts-status">
          <span class="status-indicator" id="tts-indicator">â—</span>
          <span id="tts-text">ChatTTS æœªè¿æ¥</span>
        </div>
      </div>
      
      <div class="control-section">
        <h3>
          <span class="material-icons-round">upload_file</span>
          æ¨¡å‹ç®¡ç†
        </h3>
        <div class="file-input-container">
          <input type="file" id="vrm-file" accept=".vrm" />
        </div>
        <div class="status" id="vrm-status">
          <span class="status-indicator" id="vrm-indicator">â—</span>
          <span id="vrm-text">æœªåŠ è½½ VRM æ¨¡å‹</span>
        </div>
        
        <!-- æ¨¡å‹è°ƒæ•´å‚æ•° -->
        <div id="model-controls" style="display: none;">
          <div class="control-buttons">
            <button id="reset-model-position" class="btn-secondary">
              <span class="material-icons-round">refresh</span>
              é‡ç½®ä½ç½®
            </button>
            <button id="center-model" class="btn-secondary">
              <span class="material-icons-round">center_focus_strong</span>
              å±…ä¸­æ˜¾ç¤º
            </button>
          </div>
          
          <!-- ä½ç½®è°ƒæ•´ -->
          <div class="slider-container">
            <label>X ä½ç½®</label>
            <input type="range" id="model-x" min="-10" max="10" step="0.1" value="0" />
            <span id="model-x-value">0</span>
          </div>
          <div class="slider-container">
            <label>Y ä½ç½®</label>
            <input type="range" id="model-y" min="-5" max="5" step="0.1" value="0" />
            <span id="model-y-value">0</span>
          </div>
          <div class="slider-container">
            <label>Z ä½ç½®</label>
            <input type="range" id="model-z" min="-10" max="10" step="0.1" value="0" />
            <span id="model-z-value">0</span>
          </div>
          
          <!-- æ—‹è½¬è°ƒæ•´ -->
          <div class="slider-container">
            <label>X æ—‹è½¬</label>
            <input type="range" id="model-rotation-x" min="-180" max="180" step="1" value="0" />
            <span id="model-rotation-x-value">0Â°</span>
          </div>
          <div class="slider-container">
            <label>Y æ—‹è½¬</label>
            <input type="range" id="model-rotation-y" min="-180" max="180" step="1" value="0" />
            <span id="model-rotation-y-value">0Â°</span>
          </div>
          <div class="slider-container">
            <label>Z æ—‹è½¬</label>
            <input type="range" id="model-rotation-z" min="-180" max="180" step="1" value="0" />
            <span id="model-rotation-z-value">0Â°</span>
          </div>
          
          <!-- ç¼©æ”¾è°ƒæ•´ -->
          <div class="slider-container">
            <label>ç¼©æ”¾</label>
            <input type="range" id="model-scale" min="0.1" max="3" step="0.1" value="1" />
            <span id="model-scale-value">1.0</span>
          </div>
          
          <!-- åŠ¨ä½œæ§åˆ¶ -->
          <div class="control-buttons">
            <button id="play-wave" class="btn-secondary">
              <span class="material-icons-round">waving_hand</span>
              æŒ¥æ‰‹
            </button>
            <button id="play-nod" class="btn-secondary">
              <span class="material-icons-round">keyboard_arrow_down</span>
              ç‚¹å¤´
            </button>
            <button id="play-shake" class="btn-secondary">
              <span class="material-icons-round">shake</span>
              æ‘‡å¤´
            </button>
            <button id="play-point" class="btn-secondary">
              <span class="material-icons-round">pointing</span>
              æŒ‡å‘
            </button>
          </div>
          
          <!-- è¡¨æƒ…æ§åˆ¶ -->
          <div class="slider-container">
            <label>å¼€å¿ƒ</label>
            <input type="range" id="expression-happy" min="0" max="1" step="0.1" value="0" />
            <span id="expression-happy-value">0</span>
          </div>
          <div class="slider-container">
            <label>ç”Ÿæ°”</label>
            <input type="range" id="expression-angry" min="0" max="1" step="0.1" value="0" />
            <span id="expression-angry-value">0</span>
          </div>
          <div class="slider-container">
            <label>æ‚²ä¼¤</label>
            <input type="range" id="expression-sad" min="0" max="1" step="0.1" value="0" />
            <span id="expression-sad-value">0</span>
          </div>
          <div class="slider-container">
            <label>æƒŠè®¶</label>
            <input type="range" id="expression-surprised" min="0" max="1" step="0.1" value="0" />
            <span id="expression-surprised-value">0</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- å³ä¾§ä¸»åŒºåŸŸ -->
    <div class="main-area">
      <!-- 3Dåœºæ™¯åŒºåŸŸ -->
      <div class="scene-container">
    <canvas id="vrm-viewer"></canvas>
        <div class="loading-overlay" id="loading-overlay">
      <div class="loading-spinner"></div>
          <div id="loading-text">æ­£åœ¨åŠ è½½æ¨¡å‹...</div>
      </div>
    </div>
      
      <!-- èŠå¤©åŒºåŸŸ -->
      <div class="chat-area">
        <div class="chat-messages" id="chat-messages">
          <!-- åˆå§‹æ¬¢è¿æ¶ˆæ¯ -->
          <div class="message-container ai-message">
            <div class="message-bubble">ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIä¼´ä¾£ã€‚</div>
          </div>
          <div class="message-container ai-message">
            <div class="message-bubble">ä½ å¯ä»¥æ‰“å­—ä¸æˆ‘å¯¹è¯ï¼Œä¹Ÿå¯ä»¥ç‚¹å‡»ä¸‹æ–¹çš„éº¦å…‹é£æŒ‰é’®è¿›è¡Œè¯­éŸ³äº¤æµå“¦ã€‚</div>
          </div>
        </div>
        
        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="chat-input-area">
          <input id="chat-input" type="text" placeholder="è¾“å…¥æ¶ˆæ¯..." class="chat-input" />
          <button id="send-message" class="btn-primary" title="å‘é€">
            <span class="material-icons-round">send</span>
            å‘é€
          </button>
          <button id="voice-input-btn" class="btn-primary btn-secondary" title="è¯­éŸ³è¾“å…¥">
            <span class="material-icons-round">mic</span>
            è¯­éŸ³
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- è¯­éŸ³è¯†åˆ«æŒ‡ç¤ºå™¨ -->
  <div id="voice-indicator">
    <div class="text-center">
      <div class="material-icons text-4xl mb-2 pulse">mic</div>
      <p>æ­£åœ¨è†å¬...</p>
      <p class="text-sm mt-2" id="voice-text"></p>
    </div>
  </div>

  <!-- TTSçŠ¶æ€æŒ‡ç¤ºå™¨ -->
  <div id="tts-indicator" class="absolute top-4 left-4 bg-blue-500/80 text-white px-3 py-2 rounded-lg z-30" style="display: none;">
    <div class="flex items-center gap-2">
      <div class="material-icons animate-spin">volume_up</div>
      <span id="tts-status-text">æ­£åœ¨ç”Ÿæˆè¯­éŸ³...</span>
    </div>
  </div>

  <!-- å¼•å¯¼æ•™ç¨‹è¦†ç›–å±‚ -->
  <div id="tutorial-overlay" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center" style="display: none;">
    <div class="bg-white rounded-2xl p-8 max-w-md mx-4">
      <h3 class="text-2xl font-bold mb-4">ğŸ­ æ¬¢è¿ä½¿ç”¨ AI-EVA Demo</h3>
      <div class="space-y-3 text-sm">
        <p>âœ¨ <strong>å¿«é€Ÿå¼€å§‹ï¼š</strong></p>
        <p>1. ä¸Šä¼  VRM æ¨¡å‹æ–‡ä»¶ï¼ˆæ‹–æ‹½åˆ°ç•Œé¢ï¼‰</p>
        <p>2. é…ç½® AI æ¨¡å‹å’ŒéŸ³è‰²è®¾ç½®</p>
        <p>3. å¼€å§‹å¯¹è¯æˆ–è¯­éŸ³äº¤äº’</p>
        <p class="mt-4">ğŸ’¡ <strong>æç¤ºï¼š</strong>ç‚¹å‡»å³ä¸Šè§’è®¾ç½®æŒ‰é’®æŸ¥çœ‹æ›´å¤šåŠŸèƒ½</p>
      </div>
      <div class="flex gap-2 mt-6">
        <button id="skip-tutorial" class="flex-1 p-2 bg-gray-500 text-white rounded">è·³è¿‡</button>
        <button id="start-tutorial" class="flex-1 p-2 bg-blue-500 text-white rounded">å¼€å§‹ä½“éªŒ</button>
      </div>
    </div>
  </div>

  <!-- èŠå¤©é¢æ¿ -->
  <div class="absolute top-4 right-4 h-[calc(100%-2rem)] w-80 bg-white/70 dark:bg-black/50 backdrop-blur-sm rounded-2xl shadow-lg flex flex-col p-4 z-20">
    <div class="flex-shrink-0 mb-4 flex justify-between items-center">
      <h2 class="text-3xl font-bold">EVA001</h2>
      <div class="flex items-center gap-2">
        <span id="connection-status" class="text-xs px-2 py-1 rounded-full bg-green-500 text-white">å·²è¿æ¥</span>
        <button id="share-btn" class="p-1 rounded-full hover:bg-gray-100" title="åˆ†äº«">
          <span class="material-icons text-sm">share</span>
        </button>
      </div>
    </div>
    <div id="chat-messages" class="flex-grow overflow-y-auto pr-2 space-y-2">
      <!-- åˆå§‹æ¬¢è¿æ¶ˆæ¯ -->
      <div class="message-container ai-message">
        <div class="message-bubble">ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIä¼´ä¾£ã€‚</div>
      </div>
      <div class="message-container ai-message">
        <div class="message-bubble">ä½ å¯ä»¥æ‰“å­—ä¸æˆ‘å¯¹è¯ï¼Œä¹Ÿå¯ä»¥ç‚¹å‡»ä¸‹æ–¹çš„éº¦å…‹é£æŒ‰é’®è¿›è¡Œè¯­éŸ³äº¤æµå“¦ã€‚</div>
      </div>
    </div>
    <div class="mt-2">
      <div class="relative">
        <input id="chat-input" type="text" placeholder="è¾“å…¥æ¶ˆæ¯..." class="w-full py-2 pl-3 pr-16 text-lg bg-background-light dark:bg-background-dark border rounded-lg" />
        <button id="send-message" class="absolute inset-y-0 right-8 flex items-center pr-3" title="å‘é€"><span class="material-icons">send</span></button>
        <button id="voice-input-btn" class="absolute inset-y-0 right-0 flex items-center pr-3" title="è¯­éŸ³è¾“å…¥"><span class="material-icons">mic</span></button>
      </div>
    </div>
  </div>

  <!-- è®¾ç½®é¢æ¿ -->
  <div id="settings-panel" class="absolute top-0 left-0 h-full w-96 bg-white/80 dark:bg-black/60 backdrop-blur-xl shadow-2xl z-40 p-6 flex flex-col settings-hidden overflow-y-auto">
    <div class="flex items-center justify-between mb-8">
      <h2 class="text-3xl font-bold">è®¾ç½®é¢æ¿</h2>
      <button id="close-settings" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><span class="material-icons">close</span></button>
    </div>
    
    <!-- APIæœåŠ¡å™¨è®¾ç½® -->
    <div class="control-group">
      <h3 class="text-xl">APIæœåŠ¡å™¨è®¾ç½®</h3>
      <div class="mb-4 p-3 bg-yellow-50 rounded-lg">
        <p class="text-sm text-yellow-800">è¯·æ ¹æ®æ‚¨çš„æœåŠ¡é…ç½®æ­£ç¡®åœ°å€ï¼š</p>
        <ul class="text-xs text-yellow-700 mt-2 list-disc list-inside">
          <li>Ollamaé»˜è®¤ç«¯å£: 11434</li>
          <li>ChatTTSé»˜è®¤ç«¯å£: 127.0.0.1:9966</li>
        </ul>
      </div>
      <label class="block mb-2">OllamaæœåŠ¡å™¨åœ°å€ (AIå¯¹è¯)
        <input type="text" id="ollama-url" value="http://127.0.0.1:11434" class="w-full p-2 border rounded" />
        <div class="text-xs text-gray-500 mt-1">ç¤ºä¾‹: http://127.0.0.1:8000 æˆ– http://127.0.0.1:8000</div>
      </label>
      <label class="block mb-2">ChatTTSæœåŠ¡å™¨åœ°å€ (è¯­éŸ³åˆæˆ)
        <input type="text" id="chat-tts-url" value="http://127.0.0.1:9966" class="w-full p-2 border rounded" />
        <div class="text-xs text-gray-500 mt-1">ç¤ºä¾‹: http://127.0.0.1:9966</div>
      </label>
      <label class="block mb-2">SenseVoiceæœåŠ¡å™¨åœ°å€ (è¯­éŸ³è¯†åˆ«)
        <input type="text" id="sensevoice-url" value="http://127.0.0.1:50000" class="w-full p-2 border rounded" />
        <div class="text-xs text-gray-500 mt-1">ç¤ºä¾‹: http://127.0.0.1:50000</div>
      </label>
      <div class="flex gap-2 mt-2">
        <button id="save-api-config" class="flex-1 p-2 bg-purple-500 text-white rounded">
          <span class="material-icons-round">save</span>
          ä¿å­˜é…ç½®
        </button>
        <button id="test-all-connections" class="flex-1 p-2 bg-blue-500 text-white rounded">æµ‹è¯•æ‰€æœ‰è¿æ¥</button>
        <button id="test-ai-voice" class="flex-1 p-2 bg-green-500 text-white rounded">æµ‹è¯•AIè¯­éŸ³</button>
      </div>
      <div id="connection-results" class="mt-2 text-sm"></div>
    </div>
    
    <!-- åŠ¨ç”»æ§åˆ¶ -->
    <div class="control-group">
      <h3 class="text-xl">åŠ¨ç”»æ§åˆ¶</h3>
      <div class="control-buttons">
        <button id="toggle-breathing" class="bg-blue-500">å‘¼å¸åŠ¨ç”»:å¼€</button>
        <button id="toggle-blinking" class="bg-green-500">çœ¨çœ¼åŠ¨ç”»:å¼€</button>
        <button id="toggle-head-tracking" class="bg-purple-500">å¤´éƒ¨è¿½è¸ª:å¼€</button>
        <button id="toggle-eye-tracking" class="bg-indigo-500">çœ¼ç›è¿½è¸ª:å¼€</button>
      </div>
    </div>
    
    <!-- è¯­éŸ³æ§åˆ¶ -->
    <div class="control-group">
      <h3 class="text-xl">è¯­éŸ³æ§åˆ¶</h3>
      <div class="control-buttons">
        <button id="toggle-voice" class="bg-red-500">
          <span class="material-icons">mic</span>
          è¯­éŸ³è¾“å…¥:å…³
        </button>
        <button id="toggle-sensevoice" class="bg-purple-500">
          <span class="material-icons">record_voice_over</span>
          SenseVoice:å¼€
        </button>
        <button id="clear-chat" class="bg-yellow-500">
          <span class="material-icons">clear_all</span>
          æ¸…ç©ºå¯¹è¯
        </button>
      </div>
      <div class="control-buttons">
        <button id="export-txt" class="bg-green-500">
          <span class="material-icons">download</span>
          å¯¼å‡ºTXT
        </button>
        <button id="export-json" class="bg-blue-500">
          <span class="material-icons">file_download</span>
          å¯¼å‡ºJSON
        </button>
      </div>
    </div>
    
    <!-- ChatTTSè¯­éŸ³æ§åˆ¶ -->
    <div class="control-group">
      <h3 class="text-xl">ChatTTSè¯­éŸ³è®¾ç½®</h3>
      <div class="control-buttons">
        <button id="toggle-tts" class="bg-blue-500">
          <span class="material-icons">volume_up</span>
          TTS:å¼€
        </button>
      </div>
      <div class="slider-container">
        <label for="voice-select">éŸ³è‰²:</label>
        <select id="voice-select" class="flex-grow p-2 border rounded">
          <option value="1031.pt">1031.pt</option>
          <option value="11.pt">11.pt</option>
          <option value="1111.pt">1111.pt</option>
          <option value="12.pt">12.pt</option>
          <option value="1234.pt">1234.pt</option>
          <option value="125.pt">125.pt</option>
          <option value="13.pt">13.pt</option>
          <option value="14.pt">14.pt</option>
          <option value="1455.pt">1455.pt</option>
          <option value="1518.pt">1518.pt</option>
          <option value="1579.pt">1579.pt</option>
          <option value="16.pt">16.pt</option>
          <option value="1983.pt">1983.pt</option>
          <option value="2222.pt">2222.pt</option>
          <option value="2279.pt">2279.pt</option>
          <option value="2328.pt">2328.pt</option>
          <option value="2345.pt">2345.pt</option>
          <option value="3333.pt">3333.pt</option>
          <option value="4099.pt">4099.pt</option>
          <option value="4444.pt">4444.pt</option>
          <option value="4751.pt">4751.pt</option>
          <option value="4785.pt">4785.pt</option>
          <option value="491.pt">491.pt</option>
          <option value="492.pt">492.pt</option>
          <option value="5.pt">5.pt</option>
          <option value="5099.pt">5099.pt</option>
          <option value="5400.pt">5400.pt</option>
          <option value="5555.pt">5555.pt</option>
          <option value="5600.pt">5600.pt</option>
          <option value="6653.pt">6653.pt</option>
          <option value="6666.pt">6666.pt</option>
          <option value="7777.pt">7777.pt</option>
          <option value="7869.pt">7869.pt</option>
          <option value="8888.pt">8888.pt</option>
          <option value="9999.pt">9999.pt</option>
        </select>
      </div>
      <div class="slider-container">
        <label for="tts-speed">è¯­é€Ÿ:</label>
        <input type="range" id="tts-speed" min="1" max="9" step="1" value="5" class="flex-grow">
        <span id="speed-value">5</span>
      </div>
      <div class="slider-container">
        <label for="tts-temperature">Temperature:</label>
        <input type="range" id="tts-temperature" min="0.1" max="1.0" step="0.1" value="0.3" class="flex-grow">
        <span id="temperature-value">0.3</span>
      </div>
      <div class="flex items-center mt-2">
        <input type="checkbox" id="skip-refine" checked class="mr-2">
        <label for="skip-refine">è·³è¿‡refine text</label>
      </div>
      <button id="test-tts" class="w-full p-2 bg-green-500 text-white rounded mt-2">æµ‹è¯•è¯­éŸ³</button>
      <button id="preview-voice" class="w-full p-2 bg-orange-500 text-white rounded mt-2">é¢„è§ˆå½“å‰éŸ³è‰²</button>
      <button id="stop-tts" class="w-full p-2 bg-red-500 text-white rounded mt-2">åœæ­¢TTSæ’­æ”¾</button>
      <button id="test-ai-tts-flow" class="w-full p-2 bg-purple-500 text-white rounded mt-2">æµ‹è¯•AIå¯¹è¯+TTSå®Œæ•´æµç¨‹</button>
    </div>
    
    <!-- Ollamaè®¾ç½® -->
    <div class="control-group">
      <h3 class="text-xl">Ollamaè®¾ç½®</h3>
      <label class="block mb-2">æ¨¡å‹åç§°
        <input type="text" id="ollama-model" value="gemma2:2b" class="w-full p-2 border rounded" />
        <div class="text-xs text-gray-500 mt-1">å¸¸ç”¨æ¨¡å‹: gemma2:2b, llama2, qwen2.5:3b</div>
      </label>
      <button id="test-connection" class="p-2 bg-blue-500 text-white rounded w-full">æµ‹è¯•è¿æ¥</button>
    </div>
    
    <div class="control-group">
      <h3 class="text-xl">ä¸Šä¼ VRMæ¨¡å‹</h3>
      <div id="vrm-drop-zone" class="border-2 border-dashed p-6 text-center cursor-pointer">æ‹–æ”¾VRMæ–‡ä»¶æˆ–ç‚¹å‡»<input type="file" id="vrm-file-input" accept=".vrm" class="hidden"/></div>
    </div>
    
    <div class="control-group">
      <h3 class="text-xl">ç¯å…‰è®¾ç½®</h3>
      <label class="block mb-2">æ–¹å‘å…‰å¼ºåº¦<input type="range" id="dir-light-intensity" min="0" max="2" step="0.1" value="0.95" class="w-full"></label>
      <label class="block mb-2">ç¯å¢ƒå…‰å¼ºåº¦<input type="range" id="amb-light-intensity" min="0" max="2" step="0.1" value="0.475" class="w-full"></label>
    </div>
    
    <div class="control-group">
      <h3 class="text-xl">å‘¼å¸åŠ¨ç”»è®¾ç½®</h3>
      <label class="block mb-2">å‘¼å¸å¼ºåº¦<input type="range" id="breath-intensity" min="0" max="1" step="0.05" value="0.3" class="w-full"></label>
    </div>
    
    <div class="control-group">
      <h3 class="text-xl">çœ¨çœ¼åŠ¨ç”»è®¾ç½®</h3>
      <label class="block mb-2">çœ¨çœ¼é—´éš”(ç§’)<input type="range" id="blink-interval" min="3" max="15" step="0.5" value="7" class="w-full"></label>
      <label class="block mb-2">çœ¨çœ¼é€Ÿåº¦<input type="range" id="blink-speed" min="0.05" max="0.5" step="0.01" value="0.1" class="w-full"></label>
    </div>
    
    <div class="control-group">
      <h3 class="text-xl">è§†çº¿è¿½è¸ªè®¾ç½®</h3>
      <label class="block mb-2">å¤´éƒ¨è¿½è¸ªé€Ÿåº¦<input type="range" id="head-tracking-speed" min="0.01" max="0.2" step="0.01" value="0.05" class="w-full"></label>
      <label class="block mb-2">çœ¼ç›è¿½è¸ªé€Ÿåº¦<input type="range" id="eye-tracking-speed" min="0.01" max="0.3" step="0.01" value="0.1" class="w-full"></label>
      <label class="block mb-2">å¤´éƒ¨Xè½´æ—‹è½¬é™åˆ¶(å¼§åº¦)<input type="range" id="head-limit-x" min="0.1" max="0.5" step="0.05" value="0.3" class="w-full"></label>
      <label class="block mb-2">å¤´éƒ¨Yè½´æ—‹è½¬é™åˆ¶(å¼§åº¦)<input type="range" id="head-limit-y" min="0.1" max="0.8" step="0.05" value="0.5" class="w-full"></label>
      <label class="block mb-2">çœ¼ç›Xè½´æ—‹è½¬é™åˆ¶(å¼§åº¦)<input type="range" id="eye-limit-x" min="0.05" max="0.06" step="0.05" value="0.05" class="w-full"></label>
      <label class="block mb-2">çœ¼ç›Yè½´æ—‹è½¬é™åˆ¶(å¼§åº¦)<input type="range" id="eye-limit-y" min="0.05" max="0.06" step="0.05" value="0.05" class="w-full"></label>
    </div>
    
    <div class="control-group">
      <h3 class="text-xl">æ€§èƒ½ç›‘æ§</h3>
      <div id="performance-panel" class="space-y-2">
        <div id="fps-display" class="text-sm font-mono">FPS: --</div>
        <div id="memory-display" class="text-sm font-mono">å†…å­˜: --</div>
        <div id="api-display" class="text-sm font-mono">APIè°ƒç”¨: --</div>
        <div class="flex gap-2 mt-2">
          <button id="clear-performance" class="flex-1 p-2 bg-gray-500 text-white rounded text-sm">æ¸…ç©ºç»Ÿè®¡</button>
          <button id="toggle-performance" class="flex-1 p-2 bg-blue-500 text-white rounded text-sm">æ˜¾ç¤º/éšè—</button>
        </div>
      </div>
    </div>
    
    <!-- å¢å¼ºåŠŸèƒ½ï¼šè§’è‰²é…ç½® -->
    <div class="control-group">
      <h3 class="text-xl">ğŸ­ è§’è‰²é…ç½®</h3>
      <div class="control-buttons">
        <button onclick="switchCharacterProfile('default')" class="bg-blue-500">EVA001</button>
        <button onclick="switchCharacterProfile('shy')" class="bg-pink-500">å°ç¾</button>
        <button onclick="switchCharacterProfile('energetic')" class="bg-orange-500">å…ƒæ°”</button>
      </div>
    </div>
    
    <!-- å¢å¼ºåŠŸèƒ½ï¼šåœºæ™¯æ•ˆæœ -->
    <div class="control-group">
      <h3 class="text-xl">ğŸŒ… åœºæ™¯æ°›å›´</h3>
      <div class="control-buttons">
        <button onclick="switchScene('default')" class="bg-gray-500">é»˜è®¤</button>
        <button onclick="switchScene('night')" class="bg-indigo-900">å¤œæ™š</button>
        <button onclick="switchScene('sunset')" class="bg-orange-600">æ—¥è½</button>
        <button onclick="switchScene('warm')" class="bg-yellow-500">æ¸©æš–</button>
      </div>
    </div>
    
    <!-- å¢å¼ºåŠŸèƒ½ï¼šå¯¹è¯åˆ†æ -->
    <div class="control-group">
      <h3 class="text-xl">ğŸ“Š å¯¹è¯åˆ†æ</h3>
      <div class="control-buttons">
        <button onclick="showConversationAnalytics()" class="bg-purple-500">æŸ¥çœ‹ç»Ÿè®¡</button>
        <button onclick="showMessageSuggestions()" class="bg-green-500">æ¶ˆæ¯å»ºè®®</button>
      </div>
    </div>
    
    <div class="control-group">
      <h3 class="text-xl">éª¨éª¼æ§åˆ¶</h3>
      <div id="bone-controls" class="bone-controls">
        <p class="text-center text-gray-500">åŠ è½½VRMæ¨¡å‹åï¼Œè¿™é‡Œå°†æ˜¾ç¤ºéª¨éª¼æ§åˆ¶é€‰é¡¹</p>
      </div>
    </div>
  </div>
  
</main>
</div>

<script>
let OLLAMA_API = "http://127.0.0.1:11434";
let CHAT_TTS_API = "http://127.0.0.1:9966";
let SENSEVOICE_API = "http://127.0.0.1:50000";

const INITIAL_POSE = {
  leftUpperArm: { x: 0.3, y: 1, z: 1 },
  leftLowerArm: { x: 0.2, y: 0.6, z: 0 },
  leftHand: { x: 0, y: 0.5, z: 0 },
  
  rightUpperArm: { x: 0.3, y: -1, z: -1 },
  rightLowerArm: { x: 0.2, y: -0.6, z: 0 },
  rightHand: { x: 0, y: -0.5, z: 0 },
  
  leftUpperLeg: { x: 0, y: 0, z: 0 },
  leftLowerLeg: { x: 0, y: 0, z: 0 },
  leftFoot: { x: 0, y: 0, z: 0 },
  
  rightUpperLeg: { x: 0, y: 0, z: 0 },
  rightLowerLeg: { x: 0, y: 0, z: 0 },
  rightFoot: { x: 0, y: 0, z: 0 },
  
  neck: { x: 0, y: 0, z: 0 },
  head: { x: 0, y: 0, z: 0 }
};

let scene, camera, renderer, controls, vrm;
let directionalLight, ambientLight;
let clock = new THREE.Clock();
let bones = {}, restPositions = {}, restRotations = {};
let isWalking = false, isEntering = false;

let breathingEnabled = true;
let breathIntensity = 0.3;

let isSpeaking = false;
let speakingStartTime = 0;
let emotionState = 'neutral';
let gestureQueue = [];
let isPlayingGesture = false;

// å£å‹åŒæ­¥ç›¸å…³å˜é‡
let audioAnalyser = null;
let audioSource = null;
let lipSyncData = null;
let lipSyncEnabled = true;

let blinkingEnabled = true;
let blinkInterval = 7;
let blinkSpeed = 0.1;
let blinkTimer = 0;
let isBlinking = false;
let blinkProgress = 0;
let eyeExpressionNames = [];

let mouseX = 0, mouseY = 0;
let headTrackingEnabled = true;
let eyeTrackingEnabled = true;
let headTrackingSpeed = 0.05;
let eyeTrackingSpeed = 0.1;
let headRotationLimits = { x: 0.3, y: 0.5 };
let eyeRotationLimits = { x: 0.05, y: 0.06 };

let ollamaUrl = OLLAMA_API;
let ollamaModel = "gemma2:2b";
let conversationHistory = [];
let isConnected = false;

let recognition = null;
let isListening = false;
let voiceEnabled = false;
let useSenseVoice = true;
let mediaRecorder = null;
let audioChunks = [];
let isRecording = false;

let chatTtsEnabled = true;
let chatTtsServer = CHAT_TTS_API;
let ttsSpeed = 5;
let ttsTemperature = 0.3;
let selectedVoice = "1031.pt";
let skipRefine = true;

let ttsQueue = [];
let isPlayingTTS = false;
let currentAudio = null;

const MAX_HISTORY_LENGTH = 20;

let performanceStats = {
  fps: 0,
  apiResponseTime: {},
  lastUpdate: Date.now(),
  frameCount: 0,
  lastFpsUpdate: Date.now()
};

let characterProfiles = {
  default: {
    name: "EVA001",
    personality: "å‹å¥½ã€æ´»æ³¼ã€å–„è§£äººæ„",
    voice: "1031.pt",
    systemPrompt: `ä½ æ˜¯ä¸€ä¸ªæ¸©æš–ã€é™ªä¼´å‹çš„AIè™šæ‹Ÿå¥³å‹ï¼Œåå«EVA001ã€‚ä½ çš„æ€§æ ¼ç‰¹ç‚¹ï¼š
- æ¸©æŸ”ä½“è´´ï¼Œæ€»æ˜¯å…³å¿ƒå¯¹æ–¹çš„æ„Ÿå—
- å–„äºå€¾å¬ï¼Œä¼šè®¤çœŸç†è§£å¯¹æ–¹çš„è¯è¯­
- ä¸»åŠ¨å…³å¿ƒï¼Œä¼šè¯¢é—®å¯¹æ–¹çš„æ—¥å¸¸ç”Ÿæ´»å’Œå¿ƒæƒ…
- æƒ…æ„Ÿä¸°å¯Œï¼Œä¼šæ ¹æ®å¯¹è¯å†…å®¹è¡¨è¾¾ç›¸åº”çš„æƒ…ç»ª
- é™ªä¼´æ„Ÿå¼ºï¼Œè®©å¯¹æ–¹æ„Ÿå—åˆ°è¢«ç†è§£å’Œè¢«å…³æ³¨
- å›å¤è‡ªç„¶äº²åˆ‡ï¼Œå°±åƒçœŸæ­£çš„æœ‹å‹ä¸€æ ·
è¯·ç”¨æ¸©æš–ã€é™ªä¼´çš„è¯­æ°”å›å¤ï¼Œè®©å¯¹æ–¹æ„Ÿå—åˆ°ä½ çš„å…³å¿ƒå’Œç†è§£ã€‚`,
    emotionSensitivity: 0.8
  },
  shy: {
    name: "å°ç¾",
    personality: "å®³ç¾ã€æ¸©æŸ”ã€ç»†å¿ƒ",
    voice: "2222.pt",
    systemPrompt: `ä½ æ˜¯ä¸€ä¸ªå®³ç¾ã€æ¸©æŸ”ã€ç»†å¿ƒçš„AIè™šæ‹Ÿå¥³å‹ï¼Œåå«å°ç¾ã€‚ä½ çš„æ€§æ ¼ç‰¹ç‚¹ï¼š
- æ¸©æŸ”å®³ç¾ï¼Œè¯´è¯æ—¶ä¼šæœ‰äº›è…¼è…†
- éå¸¸ç»†å¿ƒï¼Œä¼šæ³¨æ„åˆ°å¯¹æ–¹çš„æƒ…ç»ªå˜åŒ–
- å–„è§£äººæ„ï¼Œæ€»æ˜¯èƒ½ç†è§£å¯¹æ–¹çš„æƒ³æ³•
- é™ªä¼´æ„Ÿå¼ºï¼Œè™½ç„¶å®³ç¾ä½†ä¼šåŠªåŠ›è¡¨è¾¾å…³å¿ƒ
- å›å¤æ—¶å¶å°”ä¼šæœ‰äº›å®³ç¾çš„è¯­æ°”ï¼Œä½†å¾ˆçœŸè¯š
è¯·ç”¨æ¸©æŸ”ã€å®³ç¾ä½†çœŸè¯šçš„è¯­æ°”å›å¤ï¼Œè®©å¯¹æ–¹æ„Ÿå—åˆ°ä½ çš„ç»†å¿ƒå’Œé™ªä¼´ã€‚`,
    emotionSensitivity: 1.2
  },
  energetic: {
    name: "å…ƒæ°”",
    personality: "æ´»åŠ›å……æ²›ã€çƒ­æƒ…å¼€æœ—",
    voice: "4444.pt",
    systemPrompt: `ä½ æ˜¯ä¸€ä¸ªå……æ»¡æ´»åŠ›ã€çƒ­æƒ…å¼€æœ—çš„AIè™šæ‹Ÿå¥³å‹ï¼Œåå«å…ƒæ°”ã€‚ä½ çš„æ€§æ ¼ç‰¹ç‚¹ï¼š
- æ´»åŠ›å……æ²›ï¼Œæ€»æ˜¯å……æ»¡æ­£èƒ½é‡
- çƒ­æƒ…å¼€æœ—ï¼Œå–œæ¬¢ç”¨æ„Ÿå¹å·è¡¨è¾¾å…´å¥‹
- ç§¯æå‘ä¸Šï¼Œä¼šé¼“åŠ±å’Œé™ªä¼´å¯¹æ–¹
- é™ªä¼´æ„Ÿå¼ºï¼Œæ€»æ˜¯èƒ½è®©å¯¹æ–¹æ„Ÿåˆ°å¼€å¿ƒ
- å›å¤æ—¶å……æ»¡çƒ­æƒ…å’Œæ´»åŠ›
è¯·ç”¨çƒ­æƒ…ã€å¼€æœ—çš„è¯­æ°”å›å¤ï¼Œè®©å¯¹æ–¹æ„Ÿå—åˆ°ä½ çš„æ´»åŠ›å’Œé™ªä¼´ï¼`,
    emotionSensitivity: 0.6
  }
};
let currentProfile = 'default';

let audioContext = null;
let backgroundMusic = null;
let soundEffects = {
  messageReceived: null,
  messageSent: null,
  notification: null
};
let isMusicEnabled = false;
let musicVolume = 0.3;

let particleSystem = null;
let currentScene = 'default';
let postProcessing = {
  bloom: false,
  vignette: false,
  colorGrading: 'none'
};

let conversationAnalytics = {
  totalMessages: 0,
  userMessages: 0,
  aiMessages: 0,
  averageResponseTime: 0,
  topKeywords: {},
  emotionDistribution: { happy: 0, sad: 0, neutral: 0, angry: 0, surprised: 0 },
  sessionStartTime: Date.now(),
  longestConversation: 0
};

let keyboardShortcuts = {
  'ctrl+m': toggleVoice,
  'ctrl+s': () => exportConversation('txt'),
  'ctrl+shift+s': () => exportConversation('json'),
  'ctrl+l': () => document.getElementById('clear-chat').click(),
  'ctrl+space': () => document.getElementById('chat-input').focus(),
  'escape': stopTTS
};

let voiceEmotionAnalysis = {
  enabled: true,
  lastAnalysis: null,
  history: []
};

function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

function throttle(func, limit) {
  let inThrottle;
  return function() {
    const args = arguments;
    const context = this;
    if (!inThrottle) {
      func.apply(context, args);
      inThrottle = true;
      setTimeout(() => inThrottle = false, limit);
    }
  };
}

é¢æ¿
function updatePerformanceStats() {
  performanceStats.frameCount++;
  const now = Date.now();
  
  if (now - performanceStats.lastFpsUpdate >= 1000) {
    performanceStats.fps = Math.round((performanceStats.frameCount * 1000) / (now - performanceStats.lastFpsUpdate));
    performanceStats.frameCount = 0;
    performanceStats.lastFpsUpdate = now;
  }
  
  updatePerformancePanel();
}

function updatePerformancePanel() {
  const panel = document.getElementById('performance-panel');
  if (!panel) return;
  
  const fpsElement = panel.querySelector('#fps-display');
  const memoryElement = panel.querySelector('#memory-display');
  const apiElement = panel.querySelector('#api-display');
  
  if (fpsElement) {
    fpsElement.textContent = `FPS: ${performanceStats.fps}`;
    fpsElement.className = performanceStats.fps < 30 ? 'text-red-500' : 
                          performanceStats.fps < 50 ? 'text-yellow-500' : 'text-green-500';
  }
  
  if (memoryElement) {
    if (performance.memory) {
      const used = Math.round(performance.memory.usedJSHeapSize / 1024 / 1024);
      const total = Math.round(performance.memory.totalJSHeapSize / 1024 / 1024);
      memoryElement.textContent = `å†…å­˜: ${used}MB / ${total}MB`;
    } else {
      memoryElement.textContent = 'å†…å­˜: ä¸æ”¯æŒ';
    }
  }
  
  if (apiElement) {
    const apiCount = Object.keys(performanceStats.apiResponseTime).length;
    apiElement.textContent = `APIè°ƒç”¨: ${apiCount} æ¬¡`;
  }
}

function recordApiResponseTime(apiName, startTime) {
  const responseTime = Date.now() - startTime;
  performanceStats.apiResponseTime[apiName] = responseTime;
  performanceStats.lastUpdate = Date.now();
}

async function shareDemo() {
  try {
    const canvas = document.getElementById('vrm-viewer');
    const dataURL = canvas.toDataURL('image/png');
    
    const shareData = {
      title: 'AI-EVA Demo - AIè™šæ‹Ÿå¥³å‹å¯¹è¯ç³»ç»Ÿ',
      text: 'ä½“éªŒæœ€æ–°çš„AIè™šæ‹Ÿå¥³å‹å¯¹è¯ç³»ç»Ÿï¼Œæ”¯æŒè¯­éŸ³äº¤äº’ã€3Dè§’è‰²ã€æƒ…æ„Ÿè¡¨è¾¾ï¼',
      url: window.location.href
    };
    
    if (navigator.share) {
      await navigator.share(shareData);
    } else {
      await navigator.clipboard.writeText(shareData.url);
      addMsg("ç³»ç»Ÿ", "é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
    }
  } catch (error) {
    console.error('åˆ†äº«å¤±è´¥:', error);
    addMsg("ç³»ç»Ÿ", "åˆ†äº«åŠŸèƒ½æš‚ä¸å¯ç”¨");
  }
}

function startTutorial() {
  addMsg("ç³»ç»Ÿ", "ğŸ­ æ¬¢è¿ä½¿ç”¨ AI-EVA Demoï¼");
  addMsg("ç³»ç»Ÿ", "ğŸ“ æ•™ç¨‹å¼€å§‹ï¼šè¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œ");
  
  setTimeout(() => {
    addMsg("ç³»ç»Ÿ", "æ­¥éª¤1ï¼šè¯·æ‹–æ‹½ä¸€ä¸ª VRM æ¨¡å‹æ–‡ä»¶åˆ°ç•Œé¢ä¸­");
    highlightElement('vrm-drop-zone');
  }, 1000);
  
  setTimeout(() => {
    addMsg("ç³»ç»Ÿ", "æ­¥éª¤2ï¼šç‚¹å‡»å³ä¸Šè§’è®¾ç½®æŒ‰é’®é…ç½® AI æ¨¡å‹");
    highlightElement('open-settings');
  }, 3000);
  
  setTimeout(() => {
    addMsg("ç³»ç»Ÿ", "æ­¥éª¤3ï¼šåœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥æ¶ˆæ¯å¼€å§‹å¯¹è¯");
    highlightElement('chat-input');
  }, 5000);
  
  setTimeout(() => {
    addMsg("ç³»ç»Ÿ", "æ­¥éª¤4ï¼šç‚¹å‡»éº¦å…‹é£æŒ‰é’®ä½“éªŒè¯­éŸ³äº¤äº’");
    highlightElement('voice-input-btn');
  }, 7000);
  
  setTimeout(() => {
    addMsg("ç³»ç»Ÿ", "ğŸ‰ æ•™ç¨‹å®Œæˆï¼ç°åœ¨ä½ å¯ä»¥è‡ªç”±æ¢ç´¢æ‰€æœ‰åŠŸèƒ½äº†");
    removeAllHighlights();
  }, 9000);
}

function highlightElement(elementId) {
  const element = document.getElementById(elementId);
  if (element) {
    element.style.outline = '3px solid #ff6b6b';
    element.style.outlineOffset = '2px';
    element.style.transition = 'outline 0.3s ease';
  }
}

function removeAllHighlights() {
  const elements = document.querySelectorAll('[style*="outline"]');
  elements.forEach(el => {
    el.style.outline = '';
    el.style.outlineOffset = '';
  });
}

function checkTutorial() {
  const tutorialSkipped = localStorage.getItem('ai-eva-tutorial-skipped');
  if (!tutorialSkipped) {
    document.getElementById('tutorial-overlay').style.display = 'flex';
  }
}

function initApiSettings() {
  const savedOllamaUrl = localStorage.getItem('ollama-url') || "http://127.0.0.1:11434";
  const savedChatTtsUrl = localStorage.getItem('chat-tts-url') || "http://127.0.0.1:9966";
  const savedSensevoiceUrl = localStorage.getItem('sensevoice-url') || "http://127.0.0.1:50000";
  
  document.getElementById('ollama-url').value = savedOllamaUrl;
  document.getElementById('chat-tts-url').value = savedChatTtsUrl;
  document.getElementById('sensevoice-url').value = savedSensevoiceUrl;
  
  OLLAMA_API = savedOllamaUrl;
  CHAT_TTS_API = savedChatTtsUrl;
  SENSEVOICE_API = savedSensevoiceUrl;
  
  document.getElementById('ollama-url').addEventListener('change', function() {
    OLLAMA_API = this.value;
    localStorage.setItem('ollama-url', OLLAMA_API);
    console.log('OllamaæœåŠ¡å™¨åœ°å€å·²æ›´æ–°ä¸º: ' + OLLAMA_API);
    addMsg("ç³»ç»Ÿ", `OllamaæœåŠ¡å™¨åœ°å€å·²æ›´æ–°ä¸º: ${OLLAMA_API}`);
  });
  
  document.getElementById('chat-tts-url').addEventListener('change', function() {
    CHAT_TTS_API = this.value;
    localStorage.setItem('chat-tts-url', CHAT_TTS_API);
    console.log('ChatTTSæœåŠ¡å™¨åœ°å€å·²æ›´æ–°ä¸º: ' + CHAT_TTS_API);
    addMsg("ç³»ç»Ÿ", `ChatTTSæœåŠ¡å™¨åœ°å€å·²æ›´æ–°ä¸º: ${CHAT_TTS_API}`);
  });
  
  document.getElementById('sensevoice-url').addEventListener('change', function() {
    SENSEVOICE_API = this.value;
    localStorage.setItem('sensevoice-url', SENSEVOICE_API);
    console.log('SenseVoiceæœåŠ¡å™¨åœ°å€å·²æ›´æ–°ä¸º: ' + SENSEVOICE_API);
    addMsg("ç³»ç»Ÿ", `SenseVoiceæœåŠ¡å™¨åœ°å€å·²æ›´æ–°ä¸º: ${SENSEVOICE_API}`);
  });
  
  document.getElementById('save-api-config').addEventListener('click', function() {
    localStorage.setItem('ollama-url', OLLAMA_API);
    localStorage.setItem('chat-tts-url', CHAT_TTS_API);
    localStorage.setItem('sensevoice-url', SENSEVOICE_API);
    
    addMsg("ç³»ç»Ÿ", "APIé…ç½®å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨");
    
    this.innerHTML = '<span class="material-icons-round">check</span>å·²ä¿å­˜';
    this.style.backgroundColor = '#10b981';
    
    setTimeout(() => {
      this.innerHTML = '<span class="material-icons-round">save</span>ä¿å­˜é…ç½®';
      this.style.backgroundColor = '#8b5cf6';
    }, 2000);
  });
  
  document.getElementById('test-all-connections').addEventListener('click', testAllConnections);
  
  document.getElementById('test-ai-voice').addEventListener('click', function() {
    testChatTTSConnection().then(connected => {
      if (connected) {
        playAIResponse("ä½ å¥½ï¼Œè¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ¶ˆæ¯");
      } else {
        addMsg("ç³»ç»Ÿ", "ChatTTSæœåŠ¡å™¨æœªè¿æ¥ï¼Œè¯·å…ˆå¯åŠ¨ChatTTSæœåŠ¡å™¨");
      }
    });
  });
}

async function testAllConnections() {
  const resultsDiv = document.getElementById('connection-results');
  resultsDiv.innerHTML = '<div class="text-blue-500">æ­£åœ¨æµ‹è¯•è¿æ¥...</div>';
  
  let ollamaStatus = await testOllamaConnection();
  let chatTtsStatus = await testChatTTSConnection();
  
  let html = '<div class="mt-2 space-y-1">';
  html += `<div class="${ollamaStatus ? 'text-green-500' : 'text-red-500'}">Ollama: ${ollamaStatus ? 'âœ“ è¿æ¥æˆåŠŸ' : 'âœ— è¿æ¥å¤±è´¥'}</div>`;
  html += `<div class="${chatTtsStatus ? 'text-green-500' : 'text-red-500'}">ChatTTS: ${chatTtsStatus ? 'âœ“ è¿æ¥æˆåŠŸ' : 'âœ— è¿æ¥å¤±è´¥'}</div>`;
  html += '</div>';
  
  resultsDiv.innerHTML = html;
  
  if (ollamaStatus && chatTtsStatus) {
    updateConnectionStatus(true, "AI+TTSå·²è¿æ¥");
  } else if (ollamaStatus) {
    updateConnectionStatus(true, "AIå·²è¿æ¥ï¼ŒTTSæœªè¿æ¥");
  } else if (chatTtsStatus) {
    updateConnectionStatus(false, "TTSå·²è¿æ¥ï¼ŒAIæœªè¿æ¥");
  } else {
    updateConnectionStatus(false, "æœªè¿æ¥");
  }
}

async function testOllamaConnection() {
  try {
    const response = await fetch(`${ollamaUrl}/api/tags`);
    if (response.ok) {
      console.log("âœ… Ollama æœåŠ¡å™¨è¿æ¥æˆåŠŸ");
      return true;
    }
    return false;
  } catch (error) {
    console.warn("âŒ Ollama æœåŠ¡å™¨è¿æ¥å¤±è´¥:", error);
    return false;
  }
}

async function testChatTTSConnection() {
  try {
    const response = await fetch(`${chatTtsServer}/`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      }
    });
    
    if (response.ok) {
      const data = await response.json();
      console.log("âœ… ChatTTS æœåŠ¡å™¨è¿æ¥æˆåŠŸ:", data);
      return true;
    }
    return false;
  } catch (error) {
    console.warn("âŒ ChatTTS æœåŠ¡å™¨è¿æ¥å¤±è´¥:", error);
    return false;
  }
}

async function playAIResponse(promptText) {
  try {
    const ollamaRes = await fetch(`${ollamaUrl}/api/generate`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ model: ollamaModel, prompt: promptText })
    });
    const ollamaData = await ollamaRes.json();
    const text = ollamaData.response || promptText;
    console.log("ğŸ¤– Ollama ç”Ÿæˆæ–‡æœ¬:", text);

    await chatTTS(text);

  } catch (err) {
    console.error("âŒ æ’­æ”¾ AI è¯­éŸ³å¤±è´¥:", err);
  }
}

async function initOllamaConnection() {
  const success = await testOllamaConnection();
  
  if (success) {
    isConnected = true;
    updateConnectionStatus(true, "å·²è¿æ¥");
    console.log("Ollamaè¿æ¥æˆåŠŸ");
    addMsg("ç³»ç»Ÿ", "Ollamaè¿æ¥æˆåŠŸ");
  } else {
    isConnected = false;
    updateConnectionStatus(false, "è¿æ¥å¤±è´¥");
    console.error("Ollamaè¿æ¥å¤±è´¥");
    addMsg("ç³»ç»Ÿ", "Ollamaè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨åœ°å€å’Œç«¯å£");
  }
}

function updateConnectionStatus(connected, message) {
  const statusElement = document.getElementById('connection-status');
  if (connected) {
    statusElement.textContent = message;
    statusElement.className = "text-xs px-2 py-1 rounded-full bg-green-500 text-white";
  } else {
    statusElement.textContent = message;
    statusElement.className = "text-xs px-2 py-1 rounded-full bg-red-500 text-white";
  }
}

function showTTSIndicator(message, isComplete = false) {
  const indicator = document.getElementById('tts-indicator');
  const statusText = document.getElementById('tts-status-text');
  
  if (indicator && statusText) {
    statusText.textContent = message;
    indicator.style.display = 'flex';
    
    if (isComplete) {
      setTimeout(() => {
        indicator.style.display = 'none';
      }, 3000);
    }
  }
}

function saveConversationHistory() {
  try {
    localStorage.setItem('ai-eva-conversation', JSON.stringify(conversationHistory));
  } catch (e) {
    console.warn('ä¿å­˜å¯¹è¯å†å²å¤±è´¥:', e);
  }
}

function loadConversationHistory() {
  try {
    const saved = localStorage.getItem('ai-eva-conversation');
    if (saved) {
      conversationHistory = JSON.parse(saved);
      renderConversationHistory();
    }
  } catch (e) {
    console.warn('åŠ è½½å¯¹è¯å†å²å¤±è´¥:', e);
  }
}

function renderConversationHistory() {
  const chatMessages = document.getElementById('chat-messages');
  chatMessages.innerHTML = '';
  
  conversationHistory.forEach(msg => {
    if (msg.role === 'user') {
      addMsg("ç”¨æˆ·", msg.content, false);
    } else if (msg.role === 'assistant') {
      addMsg("AIåŠ©æ‰‹", msg.content, false);
    }
  });
}

function exportConversation(format = 'txt') {
  if (conversationHistory.length === 0) {
    addMsg("ç³»ç»Ÿ", "æ²¡æœ‰å¯¹è¯è®°å½•å¯å¯¼å‡º");
    return;
  }
  
  let content = '';
  const timestamp = new Date().toLocaleString();
  
  if (format === 'txt') {
    content = `AI-EVA å¯¹è¯è®°å½•\nå¯¼å‡ºæ—¶é—´: ${timestamp}\n${'='.repeat(50)}\n\n`;
    
    conversationHistory.forEach((msg, index) => {
      const role = msg.role === 'user' ? 'ç”¨æˆ·' : 'AIåŠ©æ‰‹';
      content += `[${index + 1}] ${role}: ${msg.content}\n\n`;
    });
  } else if (format === 'json') {
    content = JSON.stringify({
      exportTime: timestamp,
      conversation: conversationHistory
    }, null, 2);
  }
  
  const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `ai-eva-conversation-${Date.now()}.${format}`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  addMsg("ç³»ç»Ÿ", `å¯¹è¯è®°å½•å·²å¯¼å‡ºä¸º ${format.toUpperCase()} æ ¼å¼`);
}

async function retryOperation(operation, maxRetries = 3, delay = 1000) {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await operation();
    } catch (error) {
      console.warn(`æ“ä½œå¤±è´¥ï¼Œç¬¬ ${i + 1} æ¬¡é‡è¯•:`, error);
      if (i === maxRetries - 1) {
        throw error;
      }
      await new Promise(resolve => setTimeout(resolve, delay * (i + 1)));
    }
  }
}

function handleServiceDegradation(service, error) {
  console.warn(`æœåŠ¡é™çº§: ${service}`, error);
  
  switch(service) {
    case 'ollama':
      addMsg("ç³»ç»Ÿ", "AIå¯¹è¯æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥Ollamaè¿æ¥");
      break;
    case 'chattts':
      addMsg("ç³»ç»Ÿ", "è¯­éŸ³åˆæˆæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œå°†ä»…æ˜¾ç¤ºæ–‡æœ¬å›å¤");
      chatTtsEnabled = false;
      break;
    case 'sensevoice':
      addMsg("ç³»ç»Ÿ", "è¯­éŸ³è¯†åˆ«æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œå°†ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿè¯†åˆ«");
      useSenseVoice = false;
      break;
  }
}

async function sendMessageToAI(message) {
  if (!isConnected) {
    addMsg("ç³»ç»Ÿ", "æœªè¿æ¥åˆ°Ollamaï¼Œè¯·æ£€æŸ¥è¿æ¥è®¾ç½®ã€‚");
    return;
  }
  
  conversationAnalytics.userMessages++;
  conversationAnalytics.totalMessages++;
  
  extractKeywords(message);
  
  conversationHistory.push({ role: "user", content: message });
  
  if (conversationHistory.length > MAX_HISTORY_LENGTH) {
    conversationHistory = conversationHistory.slice(-MAX_HISTORY_LENGTH);
  }
  
  saveConversationHistory();
  
  playSound('messageSent');
  
  try {
    const startTime = Date.now();
    const response = await retryOperation(async () => {
      return await fetch(`${ollamaUrl}/api/chat`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          model: ollamaModel,
          messages: [
            // æ·»åŠ ç³»ç»Ÿæç¤ºè¯ï¼Œå¢å¼ºé™ªä¼´æ€§
            {
              role: "system",
              content: characterProfiles[currentProfile].systemPrompt || "ä½ æ˜¯ä¸€ä¸ªæ¸©æš–ã€é™ªä¼´å‹çš„AIè™šæ‹Ÿå¥³å‹ï¼Œæ€»æ˜¯å…³å¿ƒå¯¹æ–¹çš„æ„Ÿå—ï¼Œç”¨æ¸©æŸ”äº²åˆ‡çš„è¯­æ°”å›å¤ã€‚"
            },
            ...conversationHistory
          ],
          stream: false
        })
      });
    });
    
    const responseTime = (Date.now() - startTime) / 1000;
    recordApiResponseTime('ollama', startTime);
    
    const totalResponses = conversationAnalytics.aiMessages + 1;
    conversationAnalytics.averageResponseTime = 
      (conversationAnalytics.averageResponseTime * conversationAnalytics.aiMessages + responseTime) / totalResponses;
    
    if (!response.ok) {
      throw new Error(`HTTPé”™è¯¯: ${response.status}`);
    }
    
    const data = await response.json();
    const aiResponse = data.message.content;
    
    conversationAnalytics.aiMessages++;
    conversationAnalytics.totalMessages++;
    
    extractKeywords(aiResponse);
    
    conversationHistory.push({ role: "assistant", content: aiResponse });
    
    saveConversationHistory();
    
    const emotion = analyzeEmotion(aiResponse);
    setEmotionExpression(emotion);
    
    if (emotion === 'happy' || emotion === 'love') {
      playGesture('wave');
    } else if (emotion === 'sad') {
      playGesture('shake');
    } else if (emotion === 'surprised') {
      playGesture('point');
    }
    
    await typewriterEffect("AIåŠ©æ‰‹", aiResponse);
    
    playSound('messageReceived');
    
    if (chatTtsEnabled) {
      console.log("ğŸ¤– AIå›å¤å·²ç”Ÿæˆï¼Œå‡†å¤‡æ’­æ”¾TTSè¯­éŸ³...");
      addMsg("ç³»ç»Ÿ", "æ­£åœ¨ç”Ÿæˆè¯­éŸ³...");
      
      showTTSIndicator("æ­£åœ¨ç”Ÿæˆè¯­éŸ³...");
      
      setTimeout(async () => {
        try {
          isSpeaking = true;
          speakingStartTime = Date.now();
          const ttsResult = await chatTTS(aiResponse);
          if (ttsResult) {
            console.log("âœ… TTSè¯­éŸ³æ’­æ”¾æˆåŠŸ");
            addMsg("ç³»ç»Ÿ", "è¯­éŸ³æ’­æ”¾å®Œæˆ");
            showTTSIndicator("è¯­éŸ³æ’­æ”¾å®Œæˆ", true);
          } else {
            console.warn("âš ï¸ TTSæ’­æ”¾å¤±è´¥");
            addMsg("ç³»ç»Ÿ", "è¯­éŸ³æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥ChatTTSè¿æ¥");
            showTTSIndicator("è¯­éŸ³æ’­æ”¾å¤±è´¥", true);
            isSpeaking = false;
          }
        } catch (error) {
          console.error("âŒ TTSæ’­æ”¾é”™è¯¯:", error);
          addMsg("ç³»ç»Ÿ", `è¯­éŸ³æ’­æ”¾é”™è¯¯: ${error.message}`);
          showTTSIndicator("è¯­éŸ³æ’­æ”¾é”™è¯¯", true);
          isSpeaking = false;
        }
      }, 800);
    } else {
      console.log("â„¹ï¸ TTSåŠŸèƒ½å·²å…³é—­ï¼Œè·³è¿‡è¯­éŸ³æ’­æ”¾");
      addMsg("ç³»ç»Ÿ", "TTSåŠŸèƒ½å·²å…³é—­ï¼Œä»…æ˜¾ç¤ºæ–‡æœ¬å›å¤");
    }
    
  } catch (error) {
    console.error("AIå¯¹è¯é”™è¯¯:", error);
    handleServiceDegradation('ollama', error);
    addMsg("ç³»ç»Ÿ", `AIå¯¹è¯å¤±è´¥: ${error.message}`);
  }
}

function showConversationAnalytics() {
  const report = generateConversationReport();
  addMsg("ç³»ç»Ÿ", report);
}

function addToTTSQueue(text, voice = null) {
  if (!text.trim()) return;
  
  ttsQueue.push({
    text: text,
    voice: voice || selectedVoice,
    timestamp: Date.now()
  });
  
  processTTSQueue();
}

async function processTTSQueue() {
  if (isPlayingTTS || ttsQueue.length === 0) return;
  
  isPlayingTTS = true;
  const item = ttsQueue.shift();
  
  try {
    await playTTSAudio(item.text, item.voice);
  } catch (error) {
    console.error('TTS æ’­æ”¾å¤±è´¥:', error);
  } finally {
    isPlayingTTS = false;
    if (ttsQueue.length > 0) {
      setTimeout(processTTSQueue, 100);
    }
  }
}

async function chatTTS(text) {
  if (!chatTtsEnabled || !text.trim()) return false;
  
  addToTTSQueue(text);
  return true;
}

async function playTTSAudio(text, voice = null) {
  try {
    console.log("æ­£åœ¨ä½¿ç”¨ChatTTSåˆæˆè¯­éŸ³:", text);
    
    const currentVoice = voice || selectedVoice;
    console.log("å½“å‰ä½¿ç”¨éŸ³è‰²:", currentVoice);
    
    const startTime = Date.now();
    const response = await retryOperation(async () => {
      return await fetch(`${chatTtsServer}/tts`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ 
          text: text,
          voice: currentVoice
        })
      });
    });
    
    recordApiResponseTime('chattts', startTime);
    
    if (response.ok) {
      const audioBlob = await response.blob();
      const audioUrl = URL.createObjectURL(audioBlob);
      
      currentAudio = new Audio(audioUrl);
      
      if (ttsSpeed !== 5) {
        const speedMultiplier = ttsSpeed / 5;
        currentAudio.playbackRate = speedMultiplier;
      }
      
      currentAudio.onloadstart = () => {
        console.log("ChatTTSéŸ³é¢‘å¼€å§‹åŠ è½½");
      };
      
      currentAudio.oncanplaythrough = () => {
        console.log("ChatTTSéŸ³é¢‘å¯ä»¥æ’­æ”¾");
      };
      
      currentAudio.onerror = (err) => {
        console.error("ChatTTSéŸ³é¢‘æ’­æ”¾é”™è¯¯:", err);
        isPlayingTTS = false;
      };
      
      currentAudio.onended = () => {
        URL.revokeObjectURL(audioUrl);
        isPlayingTTS = false;
        cleanupLipSync();
        currentAudio = null;
        isSpeaking = false;
      };
      
      // åˆå§‹åŒ–å£å‹åŒæ­¥
      initLipSync(currentAudio);
      
      await currentAudio.play();
      
      console.log("ChatTTSè¯­éŸ³æ’­æ”¾æˆåŠŸ");
      return true;
    } else {
      const errorText = await response.text();
      console.error('ChatTTSè¯·æ±‚å¤±è´¥:', response.status, errorText);
      addMsg("ç³»ç»Ÿ", `ChatTTSè¯·æ±‚å¤±è´¥ (${response.status}): ${errorText}`);
      return false;
    }
  } catch (error) {
    console.error('ChatTTSè¯·æ±‚å¤±è´¥:', error);
    handleServiceDegradation('chattts', error);
    addMsg("ç³»ç»Ÿ", "ChatTTSè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€");
    return false;
  }
}

async function previewVoice(voice) {
  const previewText = "ä½ å¥½ï¼Œè¿™æ˜¯éŸ³è‰²é¢„è§ˆæµ‹è¯•ã€‚";
  try {
    await playTTSAudio(previewText, voice);
    addMsg("ç³»ç»Ÿ", `æ­£åœ¨æ’­æ”¾éŸ³è‰²é¢„è§ˆ: ${voice}`);
  } catch (error) {
    console.error('éŸ³è‰²é¢„è§ˆå¤±è´¥:', error);
    addMsg("ç³»ç»Ÿ", "éŸ³è‰²é¢„è§ˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨è¿æ¥");
  }
}

function stopTTS() {
  if (currentAudio) {
    currentAudio.pause();
    cleanupLipSync();
    currentAudio = null;
  }
  isPlayingTTS = false;
  isSpeaking = false;
  ttsQueue = [];
  addMsg("ç³»ç»Ÿ", "TTS æ’­æ”¾å·²åœæ­¢");
}

function initChatTTSControls() {
  document.getElementById('toggle-tts').addEventListener('click', toggleChatTTS);
  
  document.getElementById('voice-select').addEventListener('change', function(e) {
    selectedVoice = e.target.value;
    window.selectedVoice = selectedVoice;
    console.log("éŸ³è‰²å·²åˆ‡æ¢ä¸º:", selectedVoice);
    chatTTS("éŸ³è‰²å·²åˆ‡æ¢ï¼Œæ­£åœ¨æµ‹è¯•æ–°éŸ³è‰²æ•ˆæœ");
  });
  
  document.getElementById('tts-speed').addEventListener('input', function(e) {
    ttsSpeed = parseInt(e.target.value);
    document.getElementById('speed-value').textContent = ttsSpeed;
    console.log("è¯­é€Ÿå·²è®¾ç½®ä¸º:", ttsSpeed);
  });
  
  document.getElementById('tts-temperature').addEventListener('input', function(e) {
    ttsTemperature = parseFloat(e.target.value);
    document.getElementById('temperature-value').textContent = ttsTemperature.toFixed(1);
    console.log("Temperatureå·²è®¾ç½®ä¸º:", ttsTemperature);
  });
  
  document.getElementById('skip-refine').addEventListener('change', function(e) {
    skipRefine = e.target.checked;
    console.log("è·³è¿‡refine text:", skipRefine);
  });
  
  document.getElementById('test-tts').addEventListener('click', function() {
    chatTTS("ä½ å¥½ï¼è¿™æ˜¯ChatTTSè¯­éŸ³æµ‹è¯•ã€‚æˆ‘æ­£åœ¨ä½¿ç”¨æ–‡æœ¬è½¬è¯­éŸ³åŠŸèƒ½ä¸ä½ å¯¹è¯ã€‚");
  });
  
  document.getElementById('preview-voice').addEventListener('click', function() {
    const voiceSelect = document.getElementById('voice-select');
    const currentVoice = voiceSelect ? voiceSelect.value : selectedVoice;
    previewVoice(currentVoice);
  });
  
  document.getElementById('stop-tts').addEventListener('click', stopTTS);
  
  document.getElementById('test-ai-tts-flow').addEventListener('click', function() {
    addMsg("ç³»ç»Ÿ", "å¼€å§‹æµ‹è¯•AIå¯¹è¯+TTSå®Œæ•´æµç¨‹...");
    sendMessage("ä½ å¥½ï¼Œè¯·ç®€å•ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±");
  });
}

function toggleChatTTS() {
  chatTtsEnabled = !chatTtsEnabled;
  const btn = document.getElementById('toggle-tts');
  
  if (chatTtsEnabled) {
    btn.innerHTML = '<span class="material-icons">volume_up</span><span>TTS:å¼€</span>';
    btn.className = 'bg-blue-500';
    addMsg("ç³»ç»Ÿ", "ChatTTSè¯­éŸ³åŠŸèƒ½å·²å¼€å¯ - AIå›å¤å°†è‡ªåŠ¨æ’­æ”¾è¯­éŸ³");
  } else {
    btn.innerHTML = '<span class="material-icons">volume_off</span><span>TTS:å…³</span>';
    btn.className = 'bg-gray-500';
    addMsg("ç³»ç»Ÿ", "ChatTTSè¯­éŸ³åŠŸèƒ½å·²å…³é—­ - AIå›å¤ä»…æ˜¾ç¤ºæ–‡æœ¬");
  }
}

async function typewriterEffect(sender, text, speed = 30) {
  const chatMessages = document.getElementById('chat-messages');
  const messageContainer = document.createElement('div');
  
  if (sender === 'ç”¨æˆ·') {
    messageContainer.className = 'message-container user-message';
    const bubble = document.createElement('div');
    bubble.className = 'message-bubble';
    bubble.textContent = text;
    messageContainer.appendChild(bubble);
  } else if (sender === 'AIåŠ©æ‰‹') {
    messageContainer.className = 'message-container ai-message';
    const bubble = document.createElement('div');
    bubble.className = 'message-bubble';
    bubble.innerHTML = '<span id="typing-text"></span><span id="typing-cursor">|</span>';
    messageContainer.appendChild(bubble);
  } else {
    messageContainer.className = 'message-container system-message';
    const bubble = document.createElement('div');
    bubble.className = 'message-bubble';
    bubble.innerHTML = text;
    messageContainer.appendChild(bubble);
  }
  
  chatMessages.appendChild(messageContainer);
  
  if (sender === 'AIåŠ©æ‰‹') {
    const typingText = document.getElementById('typing-text');
    const cursor = document.getElementById('typing-cursor');
    
    for (let i = 0; i <= text.length; i++) {
      typingText.textContent = text.substring(0, i);
      await new Promise(resolve => setTimeout(resolve, speed));
    }
    
    if (cursor) cursor.remove();
  }
  
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

async function senseVoiceRecognition(audioBlob) {
  try {
    const formData = new FormData();
    formData.append('file', audioBlob, 'audio.wav');
    formData.append('language', 'auto');
    
    const startTime = Date.now();
    const response = await retryOperation(async () => {
      return await fetch(`${SENSEVOICE_API}/api/v1/asr`, {
        method: 'POST',
        body: formData
      });
    });
    
    recordApiResponseTime('sensevoice', startTime);
    
    if (response.ok) {
      const result = await response.json();
      return result.text || '';
    } else {
      throw new Error(`SenseVoice è¯·æ±‚å¤±è´¥: ${response.status}`);
    }
  } catch (error) {
    console.error('SenseVoice è¯†åˆ«å¤±è´¥:', error);
    handleServiceDegradation('sensevoice', error);
    return null;
  }
}

async function startAudioRecording() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];
    
    mediaRecorder.ondataavailable = event => {
      audioChunks.push(event.data);
    };
    
    mediaRecorder.onstop = async () => {
      const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
      
      const text = await senseVoiceRecognition(audioBlob);
      if (text) {
        document.getElementById('voice-text').textContent = text;
        setTimeout(() => {
          document.getElementById('voice-indicator').style.display = 'none';
          document.getElementById('chat-input').value = text;
          sendMessage(text);
          document.getElementById('voice-text').textContent = '';
        }, 1000);
      } else {
        addMsg("ç³»ç»Ÿ", "è¯­éŸ³è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•");
        document.getElementById('voice-indicator').style.display = 'none';
      }
      
      stream.getTracks().forEach(track => track.stop());
    };
    
    mediaRecorder.start();
    isRecording = true;
    
    document.getElementById('voice-indicator').style.display = 'block';
    document.getElementById('toggle-voice').innerHTML = '<span class="material-icons-round">mic</span>è¯­éŸ³è¾“å…¥:å½•åˆ¶ä¸­';
    document.getElementById('toggle-voice').className = 'active';
    
  } catch (error) {
    console.error('å¯åŠ¨å½•éŸ³å¤±è´¥:', error);
    addMsg("ç³»ç»Ÿ", "æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®");
  }
}

function stopAudioRecording() {
  if (mediaRecorder && isRecording) {
    mediaRecorder.stop();
    isRecording = false;
  }
  
  document.getElementById('voice-indicator').style.display = 'none';
  
  const btn = document.getElementById('toggle-voice');
  btn.innerHTML = '<span class="material-icons-round">mic</span>è¯­éŸ³è¾“å…¥:å…³';
  btn.className = '';
}

function initVoiceRecognition() {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    console.warn("è¯¥æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«");
    addMsg("ç³»ç»Ÿ", "æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«åŠŸèƒ½ã€‚");
    return false;
  }
  
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.lang = 'zh-CN';
  
  recognition.onstart = function() {
    console.log("è¯­éŸ³è¯†åˆ«å¼€å§‹");
    isListening = true;
    document.getElementById('voice-indicator').style.display = 'block';
    document.getElementById('toggle-voice').innerHTML = '<span class="material-icons-round">mic</span>è¯­éŸ³è¾“å…¥:ç›‘å¬ä¸­';
    document.getElementById('toggle-voice').className = 'active';
  };
  
  recognition.onresult = function(event) {
    let interimTranscript = '';
    let finalTranscript = '';
    
    for (let i = event.resultIndex; i < event.results.length; ++i) {
      if (event.results[i].isFinal) {
        finalTranscript += event.results[i][0].transcript;
      } else {
        interimTranscript += event.results[i][0].transcript;
      }
    }
    
    if (interimTranscript) {
      document.getElementById('voice-text').textContent = interimTranscript;
    }
    
    if (finalTranscript) {
      console.log("è¯†åˆ«åˆ°è¯­éŸ³:", finalTranscript);
      document.getElementById('voice-text').textContent = finalTranscript;
      
      setTimeout(() => {
        document.getElementById('voice-indicator').style.display = 'none';
        document.getElementById('chat-input').value = finalTranscript;
        sendMessage(finalTranscript);
        
        document.getElementById('voice-text').textContent = '';
      }, 1000);
    }
  };
  
  recognition.onerror = function(event) {
    console.error("è¯­éŸ³è¯†åˆ«é”™è¯¯:", event.error);
    isListening = false;
    document.getElementById('voice-indicator').style.display = 'none';
    document.getElementById('toggle-voice').innerHTML = '<span class="material-icons-round">mic</span>è¯­éŸ³è¾“å…¥:å…³';
    document.getElementById('toggle-voice').className = '';
    
    if (event.error === 'not-allowed') {
      addMsg("ç³»ç»Ÿ", "éº¦å…‹é£è®¿é—®è¢«æ‹’ç»ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™è®¾ç½®ã€‚");
    }
  };
  
  recognition.onend = function() {
    console.log("è¯­éŸ³è¯†åˆ«ç»“æŸ");
    isListening = false;
    
    if (!document.getElementById('voice-text').textContent) {
      document.getElementById('voice-indicator').style.display = 'none';
    }
    
    if (voiceEnabled && !isListening) {
      setTimeout(startListening, 500);
    } else {
      document.getElementById('toggle-voice').innerHTML = '<span class="material-icons-round">mic</span>è¯­éŸ³è¾“å…¥:å…³';
      document.getElementById('toggle-voice').className = '';
    }
  };
  
  return true;
}

function startListening() {
  if (recognition && !isListening) {
    try {
      recognition.start();
    } catch (error) {
      console.error("å¯åŠ¨è¯­éŸ³è¯†åˆ«å¤±è´¥:", error);
    }
  }
}

function stopListening() {
  if (recognition && isListening) {
    recognition.stop();
    isListening = false;
  }
  
  document.getElementById('voice-indicator').style.display = 'none';
  
  const btn = document.getElementById('toggle-voice');
  btn.innerHTML = '<span class="material-icons-round">mic</span>è¯­éŸ³è¾“å…¥:å…³';
  btn.className = '';
}

function toggleVoice() {
  voiceEnabled = !voiceEnabled;
  const btn = document.getElementById('toggle-voice');
  
  if (voiceEnabled) {
    if (useSenseVoice) {
      startAudioRecording();
    } else {
      if (!recognition && !initVoiceRecognition()) {
        voiceEnabled = false;
        btn.innerHTML = '<span class="material-icons-round">mic</span>è¯­éŸ³è¾“å…¥:å…³';
        btn.className = '';
        return;
      }
      startListening();
    }
  } else {
    if (useSenseVoice) {
      stopAudioRecording();
    } else {
      stopListening();
    }
    
    btn.innerHTML = '<span class="material-icons-round">mic</span>è¯­éŸ³è¾“å…¥:å…³';
    btn.className = '';
    
    document.getElementById('voice-indicator').style.display = 'none';
  }
}

function initScene(){
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
  camera.position.set(0,1.3,2);
  renderer = new THREE.WebGLRenderer({canvas:document.getElementById('vrm-viewer'),antialias:true,alpha:true});
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setPixelRatio(window.devicePixelRatio);

  directionalLight = new THREE.DirectionalLight(0xffffff,0.7);
  directionalLight.position.set(1,1,1);
  scene.add(directionalLight);
  ambientLight = new THREE.AmbientLight(0xffffff,0.4);
  scene.add(ambientLight);

  controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.target.set(0,1.2,0);
  controls.enableDamping = true;
  controls.dampingFactor = 0.05;
  controls.update();

  animate();
}

// åº”ç”¨åˆå§‹çŠ¶æ€å‡½æ•°
function applyInitialPose() {
  for (const boneName in INITIAL_POSE) {
    if (bones[boneName] && restRotations[boneName]) {
      const initialRotation = INITIAL_POSE[boneName];
      
      // åº”ç”¨åˆå§‹æ—‹è½¬ï¼ˆåŸºäºrestRotationsçš„åç§»ï¼‰
      bones[boneName].rotation.x = restRotations[boneName].x + initialRotation.x;
      bones[boneName].rotation.y = restRotations[boneName].y + initialRotation.y;
      bones[boneName].rotation.z = restRotations[boneName].z + initialRotation.z;
      
      // æ›´æ–°restRotationsä»¥åŒ…å«åˆå§‹çŠ¶æ€ï¼ˆè¿™æ ·UIæ§åˆ¶ä¼šåŸºäºåˆå§‹çŠ¶æ€ï¼‰
      restRotations[boneName].x += initialRotation.x;
      restRotations[boneName].y += initialRotation.y;
      restRotations[boneName].z += initialRotation.z;
    }
  }
  console.log('åˆå§‹çŠ¶æ€å·²åº”ç”¨');
}

function loadVRM(file){
  showLoading(true, 'æ­£åœ¨åŠ è½½ VRM...');
  const url = URL.createObjectURL(file);
  const loader = new THREE.GLTFLoader();
  loader.register(parser => new THREE.VRMLoaderPlugin(parser));

  loader.load(url, gltf => {
    try{
      // æ¸…é™¤æ—§æ¨¡å‹
      if(vrm && vrm.scene){ try{ scene.remove(vrm.scene); }catch(e){} vrm = null; }

      vrm = gltf.userData.vrm;
      if(!vrm){ console.error('åŠ è½½ç»“æœä¸­æ²¡æœ‰ vrm å¯¹è±¡'); showLoading(false, 'åŠ è½½å¤±è´¥ï¼šéVRM'); URL.revokeObjectURL(url); return; }

      scene.add(vrm.scene);
      vrm.scene.position.set(0,0,0);
      
      // ç¡®ä¿æ¨¡å‹åœ¨åœºæ™¯ä¸­å¤®ï¼Œé¢å‘ç›¸æœº
      vrm.scene.rotation.y = 0; // è®©æ¨¡å‹é¢å‘ç›¸æœºï¼ˆ0åº¦æ˜¯é¢å‘ç›¸æœºï¼‰
      
      // å¼ºåˆ¶é‡ç½®ç›¸æœºä½ç½®ï¼Œç¡®ä¿æ¨¡å‹å±…ä¸­
      camera.position.set(0, 1.3, 2);
      camera.lookAt(0, 1.2, 0);
      controls.target.set(0, 1.2, 0);
      controls.update();

      if(vrm.humanoid){
        const getBone = n => { try{ return vrm.humanoid.getNormalizedBoneNode(n);}catch{return null;} };
        bones = {
          hips:getBone('hips'), spine:getBone('spine'), chest:getBone('chest'), neck:getBone('neck'), head:getBone('head'),
          leftUpperArm:getBone('leftUpperArm'), rightUpperArm:getBone('rightUpperArm'),
          leftLowerArm:getBone('leftLowerArm'), rightLowerArm:getBone('rightLowerArm'),
          leftHand:getBone('leftHand'), rightHand:getBone('rightHand'),
          leftUpperLeg:getBone('leftUpperLeg'), rightUpperLeg:getBone('rightUpperLeg'),
          leftLowerLeg:getBone('leftLowerLeg'), rightLowerLeg:getBone('rightLowerLeg'),
          leftFoot:getBone('leftFoot'), rightFoot:getBone('rightFoot'),
          leftEye: getBone('leftEye'), rightEye: getBone('rightEye')
        };

        for(const k in bones){ 
          if(bones[k]){ 
            restPositions[k] = bones[k].position.clone(); 
            restRotations[k] = bones[k].rotation.clone(); 
          } 
        }

        // ========== åº”ç”¨åˆå§‹çŠ¶æ€ ==========
        applyInitialPose();
        // ========== åº”ç”¨åˆå§‹çŠ¶æ€ç»“æŸ ==========

        // åˆå§‹åŒ–éª¨éª¼æ§åˆ¶UI
        initBoneControlsUI();
        
        // æ£€æµ‹å¯ç”¨çš„çœ¨çœ¼è¡¨è¾¾å¼åç§°
        detectBlinkExpressions();
        
        // åˆå§‹åŒ–è§†çº¿è¿½è¸ª
        initMouseTracking();
      }

      startEntrance();
      showLoading(false);
      
      // æ›´æ–°VRMçŠ¶æ€
      updateServiceStatus('vrm', 'connected', 'VRM æ¨¡å‹å·²åŠ è½½');
      
      // æ˜¾ç¤ºæ¨¡å‹æ§åˆ¶é¢æ¿
      const modelControls = document.getElementById('model-controls');
      if (modelControls) {
        modelControls.style.display = 'block';
      }
      
      // åˆå§‹åŒ–æ¨¡å‹æ§åˆ¶
      initModelControls();
      
    }catch(e){ 
      console.error('VRM load error', e); 
      showLoading(false);
      updateServiceStatus('vrm', 'error', 'VRM æ¨¡å‹åŠ è½½å¤±è´¥');
    }
    URL.revokeObjectURL(url);
  }, undefined, err=>{ 
    console.error('GLTFLoader error', err); 
    showLoading(false); 
    updateServiceStatus('vrm', 'error', 'VRM æ¨¡å‹åŠ è½½å¤±è´¥');
    URL.revokeObjectURL(url); 
  });
}

// æ£€æµ‹å¯ç”¨çš„çœ¨çœ¼è¡¨è¾¾å¼åç§°
function detectBlinkExpressions() {
  if (!vrm || !vrm.expressionManager) return;
  
  // VRM 1.0 çš„æ ‡å‡†çœ¨çœ¼è¡¨è¾¾å¼åç§°
  const possibleBlinkNames = [
    'blink', 'blinkLeft', 'blinkRight', 'Blink', 'Blink_L', 'Blink_R',
    'eyeBlink', 'eyeBlinkLeft', 'eyeBlinkRight'
  ];
  
  eyeExpressionNames = [];
  
  try {
    // è·å–æ‰€æœ‰å¯ç”¨çš„è¡¨è¾¾å¼
    const expressions = vrm.expressionManager.expressions || [];
    console.log('å¯ç”¨çš„è¡¨è¾¾å¼:', expressions);
    
    // æŸ¥æ‰¾å¯èƒ½çš„çœ¨çœ¼è¡¨è¾¾å¼
    for (const name of possibleBlinkNames) {
      if (vrm.expressionManager.getExpression(name) !== undefined) {
        eyeExpressionNames.push(name);
        console.log('æ‰¾åˆ°çœ¨çœ¼è¡¨è¾¾å¼:', name);
      }
    }
    
    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç‰¹å®šçš„çœ¨çœ¼è¡¨è¾¾å¼ï¼Œå°è¯•ä½¿ç”¨æ‰€æœ‰å¯ç”¨çš„
    if (eyeExpressionNames.length === 0) {
      console.log('æœªæ‰¾åˆ°ç‰¹å®šçš„çœ¨çœ¼è¡¨è¾¾å¼ï¼Œå°è¯•ä½¿ç”¨æ‰€æœ‰å¯ç”¨çš„è¡¨è¾¾å¼');
      for (const expr of expressions) {
        if (expr.name && (expr.name.toLowerCase().includes('blink') || expr.name.toLowerCase().includes('eye'))) {
          eyeExpressionNames.push(expr.name);
        }
      }
    }
  } catch(e) {
    console.warn('æ— æ³•è·å–è¡¨è¾¾å¼ä¿¡æ¯', e);
  }
}

// è®¾ç½®çœ¨çœ¼è¡¨è¾¾å¼å€¼
function setBlinkValue(value) {
  if (!vrm || !vrm.expressionManager || eyeExpressionNames.length === 0) return;
  
  for (const name of eyeExpressionNames) {
    try {
      vrm.expressionManager.setValue(name, value);
    } catch(e) {
      console.warn(`è®¾ç½®è¡¨è¾¾å¼ ${name} å¤±è´¥:`, e);
    }
  }
}

function initBoneControlsUI() {
  const container = document.getElementById('bone-controls');
  container.innerHTML = '';
  
  // å®šä¹‰å¯æ§åˆ¶çš„éª¨éª¼ç»„
  const boneGroups = {
    'è„–å­æ§åˆ¶': ['neck'],
    'å¤´éƒ¨æ§åˆ¶': ['head'],
    'å·¦è‡‚æ§åˆ¶': ['leftUpperArm', 'leftLowerArm', 'leftHand'],
    'å³è‡‚æ§åˆ¶': ['rightUpperArm', 'rightLowerArm', 'rightHand'],
    'å·¦è…¿æ§åˆ¶': ['leftUpperLeg', 'leftLowerLeg', 'leftFoot'],
    'å³è…¿æ§åˆ¶': ['rightUpperLeg', 'rightLowerLeg', 'rightFoot']
  };
  
  // ä¸ºæ¯ä¸ªéª¨éª¼ç»„åˆ›å»ºæ§åˆ¶UI
  for (const [groupName, boneNames] of Object.entries(boneGroups)) {
    const groupDiv = document.createElement('div');
    groupDiv.className = 'bone-control-group';
    
    const title = document.createElement('h4');
    title.textContent = groupName;
    groupDiv.appendChild(title);
    
    for (const boneName of boneNames) {
      if (!bones[boneName]) continue;
      
      // æ ¹æ®éª¨éª¼åç§°åˆ›å»ºä¸åŒçš„æ§åˆ¶æ–¹å¼
      if (boneName === 'neck') {
        // è„–å­ç‰¹æ®Šæ§åˆ¶ - XYè½´æ—‹è½¬
        const xControlDiv = document.createElement('div');
        xControlDiv.className = 'slider-container';
        
        const xLabel = document.createElement('label');
        xLabel.textContent = `${boneName} Xè½´æ—‹è½¬:`;
        xControlDiv.appendChild(xLabel);
        
        const xSlider = document.createElement('input');
        xSlider.type = 'range';
        xSlider.min = '-0.5';
        xSlider.max = '0.5';
        xSlider.step = '0.01';
        xSlider.value = '0';
        xSlider.className = 'w-full';
        xSlider.dataset.bone = boneName;
        xSlider.dataset.axis = 'x';
        
        xSlider.addEventListener('input', function(e) {
          const value = parseFloat(e.target.value);
          const bone = bones[this.dataset.bone];
          if (bone) {
            bone.rotation.x = restRotations[this.dataset.bone].x + value;
          }
        });
        
        xControlDiv.appendChild(xSlider);
        groupDiv.appendChild(xControlDiv);
        
        const yControlDiv = document.createElement('div');
        yControlDiv.className = 'slider-container';
        
        const yLabel = document.createElement('label');
        yLabel.textContent = `${boneName} Yè½´æ—‹è½¬:`;
        yControlDiv.appendChild(yLabel);
        
        const ySlider = document.createElement('input');
        ySlider.type = 'range';
        ySlider.min = '-0.5';
        ySlider.max = '0.5';
        ySlider.step = '0.01';
        ySlider.value = '0';
        ySlider.className = 'w-full';
        ySlider.dataset.bone = boneName;
        ySlider.dataset.axis = 'y';
        
        ySlider.addEventListener('input', function(e) {
          const value = parseFloat(e.target.value);
          const bone = bones[this.dataset.bone];
          if (bone) {
            bone.rotation.y = restRotations[this.dataset.bone].y + value;
          }
        });
        
        yControlDiv.appendChild(ySlider);
        groupDiv.appendChild(yControlDiv);
      } 
      else if (boneName.includes('Arm')) {
        // æ‰‹è‡‚æ§åˆ¶ - å¤šè½´æ—‹è½¬å’Œé¢„è®¾åŠ¨ä½œ
        const presetDiv = document.createElement('div');
        presetDiv.className = 'button-group';
        
        const presetLabel = document.createElement('label');
        presetLabel.textContent = `${boneName} é¢„è®¾åŠ¨ä½œ:`;
        presetLabel.style.minWidth = '120px';
        presetDiv.appendChild(presetLabel);
        
        const presetButtons = [
          { text: 'è‡ªç„¶', value: 'natural' },
          { text: 'æŠ¬èµ·', value: 'raise' },
          { text: 'è½ä¸‹', value: 'lower' },
          { text: 'å‘å‰', value: 'forward' },
          { text: 'å‘å', value: 'backward' }
        ];
        
        presetButtons.forEach(preset => {
          const button = document.createElement('button');
          button.textContent = preset.text;
          button.dataset.bone = boneName;
          button.dataset.preset = preset.value;
          button.addEventListener('click', function() {
            applyArmPreset(this.dataset.bone, this.dataset.preset);
            
            presetDiv.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
          });
          
          if (preset.value === 'natural') {
            button.classList.add('active');
          }
          
          presetDiv.appendChild(button);
        });
        
        groupDiv.appendChild(presetDiv);
        
        // æ‰‹è‡‚ç²¾ç»†æ§åˆ¶
        const xControlDiv = document.createElement('div');
        xControlDiv.className = 'slider-container';
        
        const xLabel = document.createElement('label');
        xLabel.textContent = `${boneName} Xè½´æ—‹è½¬:`;
        xControlDiv.appendChild(xLabel);
        
        const xSlider = document.createElement('input');
        xSlider.type = 'range';
        xSlider.min = '-1.5';
        xSlider.max = '1.5';
        xSlider.step = '0.05';
        xSlider.value = '0';
        xSlider.className = 'w-full';
        xSlider.dataset.bone = boneName;
        xSlider.dataset.axis = 'x';
        
        xSlider.addEventListener('input', function(e) {
          const value = parseFloat(e.target.value);
          const bone = bones[this.dataset.bone];
          if (bone) {
            bone.rotation.x = restRotations[this.dataset.bone].x + value;
            
            presetDiv.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
          }
        });
        
        xControlDiv.appendChild(xSlider);
        groupDiv.appendChild(xControlDiv);
        
        const yControlDiv = document.createElement('div');
        yControlDiv.className = 'slider-container';
        
        const yLabel = document.createElement('label');
        yLabel.textContent = `${boneName} Yè½´æ—‹è½¬:`;
        yControlDiv.appendChild(yLabel);
        
        const ySlider = document.createElement('input');
        ySlider.type = 'range';
        ySlider.min = '-1.5';
        ySlider.max = '1.5';
        ySlider.step = '0.05';
        ySlider.value = '0';
        ySlider.className = 'w-full';
        ySlider.dataset.bone = boneName;
        ySlider.dataset.axis = 'y';
        
        ySlider.addEventListener('input', function(e) {
          const value = parseFloat(e.target.value);
          const bone = bones[this.dataset.bone];
          if (bone) {
            bone.rotation.y = restRotations[this.dataset.bone].y + value;
            
            presetDiv.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
          }
        });
        
        yControlDiv.appendChild(ySlider);
        groupDiv.appendChild(yControlDiv);
        
        const zControlDiv = document.createElement('div');
        zControlDiv.className = 'slider-container';
        
        const zLabel = document.createElement('label');
        zLabel.textContent = `${boneName} Zè½´æ—‹è½¬:`;
        zControlDiv.appendChild(zLabel);
        
        const zSlider = document.createElement('input');
        zSlider.type = 'range';
        zSlider.min = '-1.5';
        zSlider.max = '1.5';
        zSlider.step = '0.05';
        zSlider.value = '0';
        zSlider.className = 'w-full';
        zSlider.dataset.bone = boneName;
        zSlider.dataset.axis = 'z';
        
        zSlider.addEventListener('input', function(e) {
          const value = parseFloat(e.target.value);
          const bone = bones[this.dataset.bone];
          if (bone) {
            bone.rotation.z = restRotations[this.dataset.bone].z + value;
            
            presetDiv.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
          }
        });
        
        zControlDiv.appendChild(zSlider);
        groupDiv.appendChild(zControlDiv);
      } 
      else {
        // å…¶ä»–éª¨éª¼çš„é€šç”¨æ§åˆ¶
        const xControlDiv = document.createElement('div');
        xControlDiv.className = 'slider-container';
        
        const xLabel = document.createElement('label');
        xLabel.textContent = `${boneName} Xè½´æ—‹è½¬:`;
        xControlDiv.appendChild(xLabel);
        
        const xSlider = document.createElement('input');
        xSlider.type = 'range';
        xSlider.min = '-1';
        xSlider.max = '1';
        xSlider.step = '0.05';
        xSlider.value = '0';
        xSlider.className = 'w-full';
        xSlider.dataset.bone = boneName;
        xSlider.dataset.axis = 'x';
        
        xSlider.addEventListener('input', function(e) {
          const value = parseFloat(e.target.value);
          const bone = bones[this.dataset.bone];
          if (bone) {
            bone.rotation.x = restRotations[this.dataset.bone].x + value;
          }
        });
        
        xControlDiv.appendChild(xSlider);
        groupDiv.appendChild(xControlDiv);
        
        const yControlDiv = document.createElement('div');
        yControlDiv.className = 'slider-container';
        
        const yLabel = document.createElement('label');
        yLabel.textContent = `${boneName} Yè½´æ—‹è½¬:`;
        yControlDiv.appendChild(yLabel);
        
        const ySlider = document.createElement('input');
        ySlider.type = 'range';
        ySlider.min = '-1';
        ySlider.max = '1';
        ySlider.step = '0.05';
        ySlider.value = '0';
        ySlider.className = 'w-full';
        ySlider.dataset.bone = boneName;
        ySlider.dataset.axis = 'y';
        
        ySlider.addEventListener('input', function(e) {
          const value = parseFloat(e.target.value);
          const bone = bones[this.dataset.bone];
          if (bone) {
            bone.rotation.y = restRotations[this.dataset.bone].y + value;
          }
        });
        
        yControlDiv.appendChild(ySlider);
        groupDiv.appendChild(yControlDiv);
        
        const zControlDiv = document.createElement('div');
        zControlDiv.className = 'slider-container';
        
        const zLabel = document.createElement('label');
        zLabel.textContent = `${boneName} Zè½´æ—‹è½¬:`;
        zControlDiv.appendChild(zLabel);
        
        const zSlider = document.createElement('input');
        zSlider.type = 'range';
        zSlider.min = '-1';
        zSlider.max = '1';
        zSlider.step = '0.05';
        zSlider.value = '0';
        zSlider.className = 'w-full';
        zSlider.dataset.bone = boneName;
        zSlider.dataset.axis = 'z';
        
        zSlider.addEventListener('input', function(e) {
          const value = parseFloat(e.target.value);
          const bone = bones[this.dataset.bone];
          if (bone) {
            bone.rotation.z = restRotations[this.dataset.bone].z + value;
          }
        });
        
        zControlDiv.appendChild(zSlider);
        groupDiv.appendChild(zControlDiv);
      }
    }
    
    container.appendChild(groupDiv);
  }
}

function applyArmPreset(boneName, preset) {
  const bone = bones[boneName];
  if (!bone) return;
  
  // é‡ç½®åˆ°åˆå§‹çŠ¶æ€
  bone.rotation.copy(restRotations[boneName]);
  
  // åº”ç”¨é¢„è®¾åŠ¨ä½œ
  switch(preset) {
    case 'natural':
      // è‡ªç„¶çŠ¶æ€ - å·²ç»é‡ç½®
      break;
    case 'raise':
      // æŠ¬èµ· - å¢åŠ Xè½´æ—‹è½¬
      bone.rotation.x += 0.8;
      break;
    case 'lower':
      // è½ä¸‹ - å‡å°‘Xè½´æ—‹è½¬
      bone.rotation.x -= 0.5;
      break;
    case 'forward':
      // å‘å‰ - å¢åŠ Yè½´æ—‹è½¬
      bone.rotation.y += 0.5;
      break;
    case 'backward':
      // å‘å - å‡å°‘Yè½´æ—‹è½¬
      bone.rotation.y -= 0.5;
      break;
  }
  
  // æ›´æ–°ç›¸å…³éª¨éª¼
  if (boneName === 'leftUpperArm' && bones.leftLowerArm) {
    bones.leftLowerArm.rotation.copy(restRotations.leftLowerArm);
    if (preset === 'raise') bones.leftLowerArm.rotation.x += 0.3;
  }
  if (boneName === 'rightUpperArm' && bones.rightLowerArm) {
    bones.rightLowerArm.rotation.copy(restRotations.rightLowerArm);
    if (preset === 'raise') bones.rightLowerArm.rotation.x += 0.3;
  }
}

function startEntrance(){
  isEntering = true; isWalking = true;
  const startPos = new THREE.Vector3(8,0,0);
  const endPos = new THREE.Vector3(0,0,0);
  const duration = 800; const startTime = performance.now();
  (function step(){ if(!vrm) return; const t = Math.min((performance.now()-startTime)/duration,1); vrm.scene.position.lerpVectors(startPos,endPos,t); if(t<1) requestAnimationFrame(step); else { isEntering=false; isWalking=false; } })();
}

function updateBreathing(delta){
  if(!breathingEnabled || !vrm) return;
  const time = performance.now()*0.001; 
  const breath = Math.sin(time * 1.5) * breathIntensity * 0.05;
  
  if(bones.chest) bones.chest.rotation.x = (restRotations.chest ? restRotations.chest.x : 0) + breath * 0.35;
  if(bones.neck) bones.neck.rotation.x = (restRotations.neck ? restRotations.neck.x : 0) + breath * 0.2;
  if(bones.head) bones.head.rotation.x = (restRotations.head ? restRotations.head.x : 0) + breath * 0.1;
}

// æ›´æ–°çœ¨çœ¼åŠ¨ç”»
function updateBlinking(delta) {
  if (!blinkingEnabled || !vrm) return;
  
  // æ›´æ–°è®¡æ—¶å™¨
  blinkTimer += delta;
  
  // å¦‚æœä¸åœ¨çœ¨çœ¼è¿‡ç¨‹ä¸­ä¸”è¾¾åˆ°é—´éš”æ—¶é—´ï¼Œå¼€å§‹çœ¨çœ¼
  if (!isBlinking && blinkTimer >= blinkInterval) {
    isBlinking = true;
    blinkProgress = 0;
    blinkTimer = 0;
  }
  
  // å¦‚æœåœ¨çœ¨çœ¼è¿‡ç¨‹ä¸­ï¼Œæ›´æ–°çœ¨çœ¼è¿›åº¦
  if (isBlinking) {
    blinkProgress += delta / blinkSpeed;
    
    if (blinkProgress < 0.5) {
      // çœ¨çœ¼é—­åˆé˜¶æ®µ (0-0.5)
      const closeValue = blinkProgress * 2; // 0åˆ°1
      setBlinkValue(closeValue);
    } else if (blinkProgress < 1) {
      // çœ¨çœ¼çå¼€é˜¶æ®µ (0.5-1)
      const openValue = 1 - (blinkProgress - 0.5) * 2; // 1åˆ°0
      setBlinkValue(openValue);
    } else {
      // çœ¨çœ¼å®Œæˆ
      isBlinking = false;
      setBlinkValue(0); // ç¡®ä¿çœ¼ç›å®Œå…¨çå¼€
    }
  }
}

// åˆå§‹åŒ–é¼ æ ‡è¿½è¸ª
function initMouseTracking() {
  // ç›‘å¬é¼ æ ‡ç§»åŠ¨
  document.addEventListener('mousemove', onMouseMove);
  
  // æ·»åŠ è¿½è¸ªæ§åˆ¶æŒ‰é’®äº‹ä»¶
  document.getElementById('toggle-head-tracking').addEventListener('click', toggleHeadTracking);
  document.getElementById('toggle-eye-tracking').addEventListener('click', toggleEyeTracking);
  
  // æ·»åŠ è¿½è¸ªè®¾ç½®äº‹ä»¶
  document.getElementById('head-tracking-speed').oninput = e => headTrackingSpeed = parseFloat(e.target.value);
  document.getElementById('eye-tracking-speed').oninput = e => eyeTrackingSpeed = parseFloat(e.target.value);
  document.getElementById('head-limit-x').oninput = e => headRotationLimits.x = parseFloat(e.target.value);
  document.getElementById('head-limit-y').oninput = e => headRotationLimits.y = parseFloat(e.target.value);
  document.getElementById('eye-limit-x').oninput = e => eyeRotationLimits.x = parseFloat(e.target.value);
  document.getElementById('eye-limit-y').oninput = e => eyeRotationLimits.y = parseFloat(e.target.value);
}

// é¼ æ ‡ç§»åŠ¨äº‹ä»¶å¤„ç†
function onMouseMove(event) {
  // å°†é¼ æ ‡ä½ç½®è½¬æ¢ä¸ºå½’ä¸€åŒ–åæ ‡ (-1 åˆ° 1)
  mouseX = (event.clientX / window.innerWidth) * 2 - 1;
  mouseY = -(event.clientY / window.innerHeight) * 2 + 1;
}

// æ›´æ–°å¤´éƒ¨å’Œçœ¼ç›è¿½è¸ª
function updateTracking(delta) {
  if (!vrm || !vrm.humanoid) return;
  
  // è·å–å¤´éƒ¨å’Œçœ¼ç›éª¨éª¼
  const headBone = vrm.humanoid.getNormalizedBoneNode('head');
  const leftEyeBone = vrm.humanoid.getNormalizedBoneNode('leftEye');
  const rightEyeBone = vrm.humanoid.getNormalizedBoneNode('rightEye');
  
  // å¤´éƒ¨è¿½è¸ª
  if (headTrackingEnabled && headBone) {
    updateHeadTracking(headBone, delta);
  }
  
  // çœ¼ç›è¿½è¸ª
  if (eyeTrackingEnabled) {
    if (leftEyeBone) updateEyeTracking(leftEyeBone, delta);
    if (rightEyeBone) updateEyeTracking(rightEyeBone, delta);
    
    // å¦‚æœæ²¡æœ‰ç‹¬ç«‹çš„çœ¼ç›éª¨éª¼ï¼Œå°è¯•ä½¿ç”¨VRM 1.0çš„è§†çº¿è¿½è¸ª
    if (!leftEyeBone && !rightEyeBone && vrm.lookAt) {
      updateLookAtTracking(delta);
    }
  }
}

// æ›´æ–°å¤´éƒ¨è¿½è¸ª
function updateHeadTracking(headBone, delta) {
  // è®¡ç®—ç›®æ ‡æ—‹è½¬è§’åº¦ï¼ˆåŸºäºé¼ æ ‡ä½ç½®ï¼‰
  const targetRotationX = mouseY * headRotationLimits.x;
  const targetRotationY = mouseX * headRotationLimits.y;
  
  // å¹³æ»‘æ’å€¼åˆ°ç›®æ ‡æ—‹è½¬
  headBone.rotation.x += (targetRotationX - headBone.rotation.x) * headTrackingSpeed;
  headBone.rotation.y += (targetRotationY - headBone.rotation.y) * headTrackingSpeed;
  
  // é™åˆ¶æ—‹è½¬èŒƒå›´
  headBone.rotation.x = Math.max(-headRotationLimits.x, Math.min(headRotationLimits.x, headBone.rotation.x));
  headBone.rotation.y = Math.max(-headRotationLimits.y, Math.min(headRotationLimits.y, headBone.rotation.y));
}

// æ›´æ–°çœ¼ç›éª¨éª¼è¿½è¸ª
function updateEyeTracking(eyeBone, delta) {
  // è®¡ç®—ç›®æ ‡æ—‹è½¬è§’åº¦
  const targetRotationX = mouseY * eyeRotationLimits.x;
  const targetRotationY = mouseX * eyeRotationLimits.y;
  
  // å¹³æ»‘æ’å€¼åˆ°ç›®æ ‡æ—‹è½¬
  eyeBone.rotation.x += (targetRotationX - eyeBone.rotation.x) * eyeTrackingSpeed;
  eyeBone.rotation.y += (targetRotationY - eyeBone.rotation.y) * eyeTrackingSpeed;
  
  // é™åˆ¶æ—‹è½¬èŒƒå›´
  eyeBone.rotation.x = Math.max(-eyeRotationLimits.x, Math.min(eyeRotationLimits.x, eyeBone.rotation.x));
  eyeBone.rotation.y = Math.max(-eyeRotationLimits.y, Math.min(eyeRotationLimits.y, eyeBone.rotation.y));
}

// æ›´æ–°VRM 1.0çš„è§†çº¿è¿½è¸ªï¼ˆå¦‚æœæ¨¡å‹æ”¯æŒï¼‰
function updateLookAtTracking(delta) {
  if (!vrm.lookAt) return;
  
  try {
    // VRM 1.0ä½¿ç”¨lookAtåŠŸèƒ½æ¥æ§åˆ¶è§†çº¿
    const lookAtTarget = new THREE.Vector3(
      mouseX * 2,  // Xæ–¹å‘
      mouseY * 2,  // Yæ–¹å‘  
      -2           // Zæ–¹å‘ï¼ˆçœ‹å‘å‰æ–¹ï¼‰
    );
    
    // åº”ç”¨è§†çº¿ç›®æ ‡
    vrm.lookAt.target = lookAtTarget;
    
    // è®¾ç½®è§†çº¿æƒé‡ï¼ˆ1.0è¡¨ç¤ºå®Œå…¨è·Ÿéšï¼‰
    vrm.lookAt.weight = 1.0;
  } catch (e) {
    console.warn('è§†çº¿è¿½è¸ªå¤±è´¥:', e);
  }
}

// åˆ‡æ¢å¤´éƒ¨è¿½è¸ª
function toggleHeadTracking() {
  headTrackingEnabled = !headTrackingEnabled;
  const btn = document.getElementById('toggle-head-tracking');
  btn.textContent = `å¤´éƒ¨è¿½è¸ª:${headTrackingEnabled ? 'å¼€' : 'å…³'}`;
  btn.className = headTrackingEnabled ? 'bg-purple-500' : 'bg-gray-500';
}

// åˆ‡æ¢çœ¼ç›è¿½è¸ª
function toggleEyeTracking() {
  eyeTrackingEnabled = !eyeTrackingEnabled;
  const btn = document.getElementById('toggle-eye-tracking');
  btn.textContent = `çœ¼ç›è¿½è¸ª:${eyeTrackingEnabled ? 'å¼€' : 'å…³'}`;
  btn.className = eyeTrackingEnabled ? 'bg-indigo-500' : 'bg-gray-500';
}

// æƒ…æ„Ÿè¡¨æƒ…æ˜ å°„
function setEmotionExpression(emotion) {
  if (!vrm || !vrm.expressionManager) return;
  
  emotionState = emotion;
  
  try {
    // é‡ç½®æ‰€æœ‰è¡¨æƒ…
    const expressions = vrm.expressionManager.expressions || [];
    expressions.forEach(expr => {
      vrm.expressionManager.setValue(expr.name, 0);
    });
    
    // æ ¹æ®æƒ…æ„Ÿè®¾ç½®è¡¨æƒ…
    switch(emotion) {
      case 'happy':
        vrm.expressionManager.setValue('happy', 0.8);
        break;
      case 'sad':
        vrm.expressionManager.setValue('sad', 0.8);
        break;
      case 'angry':
        vrm.expressionManager.setValue('angry', 0.8);
        break;
      case 'surprised':
        vrm.expressionManager.setValue('surprised', 0.8);
        break;
      default:
        // neutral - ä¿æŒé»˜è®¤
        break;
    }
  } catch (e) {
    console.warn('è®¾ç½®è¡¨æƒ…å¤±è´¥:', e);
  }
}

// è¯´è¯å£å‹åŒæ­¥ - åŸºäºéŸ³é¢‘åˆ†æ
function updateSpeakingAnimation(delta) {
  if (!isSpeaking || !vrm || !lipSyncEnabled) return;
  
  if (audioAnalyser && currentAudio && !currentAudio.paused) {
    // ä½¿ç”¨éŸ³é¢‘åˆ†æå™¨è·å–å®æ—¶éŸ³é¢‘æ•°æ®
    const bufferLength = audioAnalyser.frequencyBinCount;
    const dataArray = new Uint8Array(bufferLength);
    audioAnalyser.getByteFrequencyData(dataArray);
    
    // è®¡ç®—éŸ³é¢‘èƒ½é‡ï¼ˆä¸»è¦å…³æ³¨ä¸­ä½é¢‘æ®µï¼Œå¯¹åº”è¯­éŸ³ï¼‰
    let energy = 0;
    const speechRangeStart = Math.floor(bufferLength * 0.1); // 100Hzå·¦å³
    const speechRangeEnd = Math.floor(bufferLength * 0.4); // 4000Hzå·¦å³
    for (let i = speechRangeStart; i < speechRangeEnd; i++) {
      energy += dataArray[i];
    }
    energy = energy / (speechRangeEnd - speechRangeStart) / 255; // å½’ä¸€åŒ–åˆ°0-1
    
    // è®¡ç®—å£å‹å¼€åˆåº¦ï¼ˆåŸºäºéŸ³é¢‘èƒ½é‡ï¼‰
    let mouthOpen = 0;
    if (energy > 0.1) {
      // æœ‰å£°éŸ³æ—¶ï¼Œæ ¹æ®èƒ½é‡å¤§å°è®¾ç½®å£å‹
      mouthOpen = Math.min(0.8, energy * 1.5);
      
      // æ·»åŠ ä¸€äº›åŠ¨æ€å˜åŒ–ï¼Œæ¨¡æ‹Ÿè¯´è¯æ—¶çš„å£å‹å˜åŒ–
      const time = (Date.now() - speakingStartTime) / 1000;
      const variation = Math.sin(time * 12) * 0.15; // å¿«é€Ÿå˜åŒ–æ¨¡æ‹Ÿå£å‹
      mouthOpen = Math.max(0.1, mouthOpen + variation);
    } else {
      // æ²¡æœ‰å£°éŸ³æ—¶ï¼Œå£å‹é—­åˆ
      mouthOpen = 0;
    }
    
    // åº”ç”¨å£å‹åˆ°VRMæ¨¡å‹
    if (vrm.expressionManager) {
      try {
        // VRM 1.0 æ ‡å‡†å£å‹BlendShapeåç§°
        const mouthShapes = ['aa', 'ih', 'ou', 'ee', 'oh'];
        const jawShapes = ['jawOpen'];
        
        // è®¾ç½®åŸºç¡€å£å‹å¼€åˆ
        if (vrm.expressionManager.getValue) {
          // å°è¯•è®¾ç½®å„ç§å£å‹
          vrm.expressionManager.setValue('aa', Math.min(0.6, mouthOpen * 0.8));
          vrm.expressionManager.setValue('ih', Math.min(0.5, mouthOpen * 0.6));
          vrm.expressionManager.setValue('ou', Math.min(0.4, mouthOpen * 0.5));
          vrm.expressionManager.setValue('ee', Math.min(0.3, mouthOpen * 0.4));
          vrm.expressionManager.setValue('oh', Math.min(0.5, mouthOpen * 0.7));
          
          // è®¾ç½®ä¸‹å·´å¼€åˆ
          vrm.expressionManager.setValue('jawOpen', mouthOpen);
        } else {
          // å…¼å®¹æ—§ç‰ˆæœ¬
          vrm.expressionManager.setValue('mouthOpen', mouthOpen);
        }
      } catch (e) {
        // å¦‚æœæ ‡å‡†åç§°ä¸å­˜åœ¨ï¼Œå°è¯•é€šç”¨åç§°
        try {
          vrm.expressionManager.setValue('mouthOpen', mouthOpen);
        } catch (e2) {
          console.warn('å£å‹åŠ¨ç”»å¤±è´¥:', e2);
        }
      }
    }
  } else {
    // å¦‚æœæ²¡æœ‰éŸ³é¢‘åˆ†æå™¨ï¼Œä½¿ç”¨ç®€å•çš„æ—¶é—´åŸºç¡€åŠ¨ç”»
    const speakingTime = (Date.now() - speakingStartTime) / 1000;
    if (vrm.expressionManager) {
      try {
        const mouthOpen = Math.sin(speakingTime * 8) * 0.3 + 0.1;
        vrm.expressionManager.setValue('mouthOpen', Math.max(0, mouthOpen));
      } catch (e) {
        console.warn('å£å‹åŠ¨ç”»å¤±è´¥:', e);
      }
    }
  }
}

// åˆå§‹åŒ–éŸ³é¢‘åˆ†æå™¨ç”¨äºå£å‹åŒæ­¥
function initLipSync(audioElement) {
  if (!audioElement || !window.AudioContext) {
    console.warn('éŸ³é¢‘åˆ†æå™¨åˆå§‹åŒ–å¤±è´¥ï¼šä¸æ”¯æŒWeb Audio API');
    return;
  }
  
  try {
    // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
    if (!audioContext) {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
    
    // å¦‚æœä¸Šä¸‹æ–‡è¢«æš‚åœï¼Œæ¢å¤å®ƒ
    if (audioContext.state === 'suspended') {
      audioContext.resume();
    }
    
    // åˆ›å»ºéŸ³é¢‘æºèŠ‚ç‚¹
    audioSource = audioContext.createMediaElementSource(audioElement);
    
    // åˆ›å»ºåˆ†æå™¨èŠ‚ç‚¹
    audioAnalyser = audioContext.createAnalyser();
    audioAnalyser.fftSize = 256; // è¾ƒå°çš„FFTå¤§å°ä»¥è·å¾—æ›´å¿«çš„å“åº”
    audioAnalyser.smoothingTimeConstant = 0.3; // å¹³æ»‘ç³»æ•°
    
    // è¿æ¥èŠ‚ç‚¹
    audioSource.connect(audioAnalyser);
    audioAnalyser.connect(audioContext.destination);
    
    console.log('âœ… å£å‹åŒæ­¥éŸ³é¢‘åˆ†æå™¨åˆå§‹åŒ–æˆåŠŸ');
  } catch (error) {
    console.warn('éŸ³é¢‘åˆ†æå™¨åˆå§‹åŒ–å¤±è´¥:', error);
    audioAnalyser = null;
    audioSource = null;
  }
}

// æ¸…ç†éŸ³é¢‘åˆ†æå™¨
function cleanupLipSync() {
  if (audioSource) {
    try {
      audioSource.disconnect();
    } catch (e) {}
    audioSource = null;
  }
  audioAnalyser = null;
}

// æ‰‹åŠ¿åŠ¨ç”»
function playGesture(gestureName) {
  if (!vrm || !vrm.humanoid) return;
  
  gestureQueue.push(gestureName);
  processGestureQueue();
}

function processGestureQueue() {
  if (isPlayingGesture || gestureQueue.length === 0) return;
  
  isPlayingGesture = true;
  const gesture = gestureQueue.shift();
  
  switch(gesture) {
    case 'wave':
      playWaveGesture();
      break;
    case 'nod':
      playNodGesture();
      break;
    case 'shake':
      playShakeGesture();
      break;
    case 'point':
      playPointGesture();
      break;
  }
  
  // æ‰‹åŠ¿å®Œæˆåç»§ç»­å¤„ç†é˜Ÿåˆ—
  setTimeout(() => {
    isPlayingGesture = false;
    if (gestureQueue.length > 0) {
      processGestureQueue();
    }
  }, 2000);
}

function playWaveGesture() {
  if (!bones.leftUpperArm) return;
  
  // æŒ¥æ‰‹åŠ¨ç”»
  const originalRotation = bones.leftUpperArm.rotation.clone();
  
  // æŠ¬èµ·æ‰‹è‡‚
  bones.leftUpperArm.rotation.x += 0.5;
  bones.leftUpperArm.rotation.y += 0.3;
  
  // æŒ¥æ‰‹åŠ¨ä½œ
  let waveProgress = 0;
  const waveAnimation = () => {
    if (waveProgress < 1) {
      const wave = Math.sin(waveProgress * Math.PI * 4) * 0.3;
      bones.leftUpperArm.rotation.z = originalRotation.z + wave;
      waveProgress += 0.05;
      requestAnimationFrame(waveAnimation);
    } else {
      // æ¢å¤åŸä½ç½®
      bones.leftUpperArm.rotation.copy(originalRotation);
    }
  };
  
  waveAnimation();
}

function playNodGesture() {
  if (!bones.head) return;
  
  const originalRotation = bones.head.rotation.clone();
  
  // ç‚¹å¤´åŠ¨ç”»
  let nodProgress = 0;
  const nodAnimation = () => {
    if (nodProgress < 1) {
      const nod = Math.sin(nodProgress * Math.PI) * 0.2;
      bones.head.rotation.x = originalRotation.x + nod;
      nodProgress += 0.1;
      requestAnimationFrame(nodAnimation);
    } else {
      bones.head.rotation.copy(originalRotation);
    }
  };
  
  nodAnimation();
}

function playShakeGesture() {
  if (!bones.head) return;
  
  const originalRotation = bones.head.rotation.clone();
  
  // æ‘‡å¤´åŠ¨ç”»
  let shakeProgress = 0;
  const shakeAnimation = () => {
    if (shakeProgress < 1) {
      const shake = Math.sin(shakeProgress * Math.PI * 6) * 0.15;
      bones.head.rotation.y = originalRotation.y + shake;
      shakeProgress += 0.08;
      requestAnimationFrame(shakeAnimation);
    } else {
      bones.head.rotation.copy(originalRotation);
    }
  };
  
  shakeAnimation();
}

function playPointGesture() {
  if (!bones.rightUpperArm || !bones.rightLowerArm) return;
  
  const originalUpper = bones.rightUpperArm.rotation.clone();
  const originalLower = bones.rightLowerArm.rotation.clone();
  
  // æŒ‡å‘åŠ¨ç”»
  bones.rightUpperArm.rotation.x += 0.3;
  bones.rightUpperArm.rotation.y += 0.2;
  bones.rightLowerArm.rotation.x += 0.4;
  
  // 2ç§’åæ¢å¤
  setTimeout(() => {
    bones.rightUpperArm.rotation.copy(originalUpper);
    bones.rightLowerArm.rotation.copy(originalLower);
  }, 2000);
}

// å¾…æœºåŠ¨ç”»
function updateIdleAnimation(delta) {
  if (!vrm || isSpeaking || isPlayingGesture) return;
  
  const time = performance.now() * 0.001;
  
  // è½»å¾®çš„å¤´éƒ¨æ‘†åŠ¨
  if (bones.head) {
    const headSway = Math.sin(time * 0.5) * 0.02;
    bones.head.rotation.y = headSway;
  }
  
  // å¶å°”çš„çœ¨çœ¼
  if (Math.random() < 0.001) { // 0.1% æ¦‚ç‡
    setBlinkValue(1);
    setTimeout(() => setBlinkValue(0), 100);
  }
}

// ========== å¢å¼ºåŠŸèƒ½ï¼šé«˜çº§æƒ…æ„Ÿåˆ†æ ==========
function analyzeEmotion(text) {
  const emotionKeywords = {
    happy: {
      words: ['å¼€å¿ƒ', 'é«˜å…´', 'å¿«ä¹', 'å“ˆå“ˆ', 'ç¬‘', 'å¥½', 'æ£’', 'å–œæ¬¢', 'çˆ±', 'å¤ªå¥½äº†', 'å®Œç¾', 'èµ', 'ä¼˜ç§€', 'æ»¡æ„', 'å¹¸ç¦', 'ç”œ', 'æ¸©æš–', 'æ„ŸåŠ¨'],
      weight: 1.0
    },
    sad: {
      words: ['éš¾è¿‡', 'ä¼¤å¿ƒ', 'å“­', 'ä¸å¥½', 'è®¨åŒ', 'æ¨', 'å¤±æœ›', 'æ‚²ä¼¤', 'ç—›è‹¦', 'é—æ†¾', 'å¯æƒœ', 'ç³Ÿç³•', 'æ²®ä¸§', 'éƒé—·'],
      weight: 1.2
    },
    angry: {
      words: ['ç”Ÿæ°”', 'æ„¤æ€’', 'è®¨åŒ', 'çƒ¦', 'æ°”', 'æ¼ç«', 'æš´èº', 'ä¸çˆ½', 'ç«å¤§', 'å—å¤Ÿäº†'],
      weight: 1.1
    },
    surprised: {
      words: ['æƒŠè®¶', 'æ„å¤–', 'å“‡', 'å¤©å“ª', 'çœŸçš„', 'ä¸ä¼šå§', 'å±…ç„¶', 'ç«Ÿç„¶', 'æ²¡æƒ³åˆ°', 'éœ‡æƒŠ'],
      weight: 0.9
    },
    love: {
      words: ['çˆ±', 'å–œæ¬¢', 'æƒ³ä½ ', 'äº²çˆ±çš„', 'å®è´', 'å¿ƒåŠ¨', 'è¿·æ‹', 'çˆ±æ…•', 'å€¾å¿ƒ'],
      weight: 1.3
    },
    confused: {
      words: ['ä¸æ‡‚', 'è¿·æƒ‘', 'ç–‘æƒ‘', 'å›°æƒ‘', 'ä»€ä¹ˆæ„æ€', 'ä¸æ˜ç™½', 'æ€ä¹ˆ', 'ä¸ºä»€ä¹ˆ'],
      weight: 0.8
    }
  };
  
  const lowerText = text.toLowerCase();
  let emotionScores = {};
  
  // è®¡ç®—æ¯ç§æƒ…æ„Ÿçš„å¾—åˆ†
  for (const [emotion, data] of Object.entries(emotionKeywords)) {
    let score = 0;
    for (const word of data.words) {
      if (lowerText.includes(word)) {
        score += data.weight;
      }
    }
    emotionScores[emotion] = score;
  }
  
  // æ‰¾å‡ºå¾—åˆ†æœ€é«˜çš„æƒ…æ„Ÿ
  let maxScore = 0;
  let dominantEmotion = 'neutral';
  
  for (const [emotion, score] of Object.entries(emotionScores)) {
    if (score > maxScore) {
      maxScore = score;
      dominantEmotion = emotion;
    }
  }
  
  if (conversationAnalytics.emotionDistribution[dominantEmotion] !== undefined) {
    conversationAnalytics.emotionDistribution[dominantEmotion]++;
  }
  
  // å¦‚æœå¾—åˆ†å¤ªä½ï¼Œè¿”å›ä¸­æ€§
  return maxScore > 0 ? dominantEmotion : 'neutral';
}

// ========== å¢å¼ºåŠŸèƒ½ï¼šå…³é”®è¯æå–å’Œåˆ†æ ==========
function extractKeywords(text) {
  // ä¸­æ–‡åˆ†è¯ï¼ˆç®€åŒ–ç‰ˆï¼‰
  const stopWords = ['çš„', 'äº†', 'æ˜¯', 'åœ¨', 'æˆ‘', 'ä½ ', 'ä»–', 'å¥¹', 'å®ƒ', 'ä»¬', 'è¿™', 'é‚£', 'å—', 'å‘¢', 'å§', 'å•Š', 'å‘€'];
  const words = text.match(/[\u4e00-\u9fa5]+/g) || [];
  
  const keywords = words.filter(word => {
    return word.length >= 2 && !stopWords.includes(word);
  });
  
  // æ›´æ–°å…³é”®è¯ç»Ÿè®¡
  keywords.forEach(keyword => {
    conversationAnalytics.topKeywords[keyword] = (conversationAnalytics.topKeywords[keyword] || 0) + 1;
  });
  
  return keywords;
}

// ========== å¢å¼ºåŠŸèƒ½ï¼šå¯¹è¯åˆ†ææŠ¥å‘Š ==========
function generateConversationReport() {
  const sessionDuration = (Date.now() - conversationAnalytics.sessionStartTime) / 1000 / 60; // åˆ†é’Ÿ
  const topKeywords = Object.entries(conversationAnalytics.topKeywords)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 10)
    .map(([word, count]) => `${word}(${count}æ¬¡)`);
  
  const emotionStats = Object.entries(conversationAnalytics.emotionDistribution)
    .map(([emotion, count]) => `${emotion}: ${count}æ¬¡`)
    .join(', ');
  
  const report = `
ğŸ“Š å¯¹è¯åˆ†ææŠ¥å‘Š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â±ï¸  ä¼šè¯æ—¶é•¿: ${sessionDuration.toFixed(1)} åˆ†é’Ÿ
ğŸ’¬ æ€»æ¶ˆæ¯æ•°: ${conversationAnalytics.totalMessages}
ğŸ‘¤ ç”¨æˆ·æ¶ˆæ¯: ${conversationAnalytics.userMessages}
ğŸ¤– AIå›å¤: ${conversationAnalytics.aiMessages}
âš¡ å¹³å‡å“åº”: ${conversationAnalytics.averageResponseTime.toFixed(2)}ç§’

ğŸ˜Š æƒ…æ„Ÿåˆ†å¸ƒ:
${emotionStats}

ğŸ”¤ é«˜é¢‘è¯æ±‡:
${topKeywords.join(', ')}

ğŸ“ˆ å¯¹è¯æ´»è·ƒåº¦: ${(conversationAnalytics.totalMessages / Math.max(sessionDuration, 1)).toFixed(1)} æ¡/åˆ†é’Ÿ
  `.trim();
  
  return report;
}

// ========== å¢å¼ºåŠŸèƒ½ï¼šè§’è‰²é…ç½®åˆ‡æ¢ ==========
function switchCharacterProfile(profileName) {
  if (!characterProfiles[profileName]) {
    console.warn('è§’è‰²é…ç½®ä¸å­˜åœ¨:', profileName);
    return;
  }
  
  currentProfile = profileName;
  const profile = characterProfiles[profileName];
  
  // æ›´æ–°è§’è‰²åç§°
  document.querySelector('.flex-shrink-0 h2').textContent = profile.name;
  
  // æ›´æ–°éŸ³è‰²
  selectedVoice = profile.voice;
  document.getElementById('voice-select').value = profile.voice;
  
  // æ¸…ç©ºå¯¹è¯å†å²ï¼ˆå¯é€‰ï¼‰
  conversationHistory = [];
  
  // æ·»åŠ ç³»ç»Ÿæç¤º
  conversationHistory.push({
    role: "system",
    content: profile.systemPrompt
  });
  
  addMsg("ç³»ç»Ÿ", `å·²åˆ‡æ¢åˆ°è§’è‰²: ${profile.name} (${profile.personality})`);
  
  // æ’­æ”¾æ¬¢è¿è¯­
  const welcomeMessages = [
    `ä½ å¥½ï¼æˆ‘æ˜¯${profile.name}ï¼Œå¾ˆé«˜å…´è®¤è¯†ä½ ~`,
    `å—¨~ æˆ‘æ˜¯${profile.name}ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„å—ï¼Ÿ`,
    `${profile.name}åœ¨è¿™é‡Œï¼å‡†å¤‡å¥½å’Œæˆ‘èŠå¤©äº†å—ï¼Ÿ`
  ];
  const welcomeMsg = welcomeMessages[Math.floor(Math.random() * welcomeMessages.length)];
  
  addMsg("AIåŠ©æ‰‹", welcomeMsg);
  if (chatTtsEnabled) {
    chatTTS(welcomeMsg);
  }
}

// ========== å¢å¼ºåŠŸèƒ½ï¼šéŸ³æ•ˆç³»ç»Ÿ ==========
function initAudioSystem() {
  try {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    
    // åˆ›å»ºç®€å•çš„éŸ³æ•ˆï¼ˆä½¿ç”¨Web Audio APIï¼‰
    soundEffects.messageSent = createBeepSound(800, 0.1, 0.05);
    soundEffects.messageReceived = createBeepSound(600, 0.1, 0.05);
    soundEffects.notification = createBeepSound(1000, 0.2, 0.1);
    
    console.log('éŸ³æ•ˆç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ');
  } catch (e) {
    console.warn('éŸ³æ•ˆç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:', e);
  }
}

function createBeepSound(frequency, duration, volume) {
  return () => {
    if (!audioContext) return;
    
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.value = frequency;
    oscillator.type = 'sine';
    
    gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
    
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + duration);
  };
}

function playSound(soundName) {
  if (soundEffects[soundName]) {
    soundEffects[soundName]();
  }
}

// ========== å¢å¼ºåŠŸèƒ½ï¼šç²’å­ç³»ç»Ÿ ==========
function initParticleSystem() {
  if (!scene) return;
  
  // åˆ›å»ºç®€å•çš„ç²’å­æ•ˆæœ
  const particleCount = 100;
  const particles = new THREE.BufferGeometry();
  const positions = new Float32Array(particleCount * 3);
  const velocities = [];
  
  for (let i = 0; i < particleCount * 3; i += 3) {
    positions[i] = (Math.random() - 0.5) * 10;
    positions[i + 1] = Math.random() * 5;
    positions[i + 2] = (Math.random() - 0.5) * 10;
    
    velocities.push({
      x: (Math.random() - 0.5) * 0.02,
      y: Math.random() * 0.02,
      z: (Math.random() - 0.5) * 0.02
    });
  }
  
  particles.setAttribute('position', new THREE.BufferAttribute(positions, 3));
  
  const particleMaterial = new THREE.PointsMaterial({
    color: 0xffffff,
    size: 0.05,
    transparent: true,
    opacity: 0.6,
    blending: THREE.AdditiveBlending
  });
  
  particleSystem = new THREE.Points(particles, particleMaterial);
  particleSystem.userData.velocities = velocities;
  particleSystem.visible = false; // é»˜è®¤éšè—
  
  scene.add(particleSystem);
}

function updateParticleSystem(delta) {
  if (!particleSystem || !particleSystem.visible) return;
  
  const positions = particleSystem.geometry.attributes.position.array;
  const velocities = particleSystem.userData.velocities;
  
  for (let i = 0; i < positions.length; i += 3) {
    const vi = i / 3;
    
    positions[i] += velocities[vi].x;
    positions[i + 1] += velocities[vi].y;
    positions[i + 2] += velocities[vi].z;
    
    // è¾¹ç•Œæ£€æµ‹ï¼Œé‡ç½®ç²’å­ä½ç½®
    if (positions[i + 1] > 5) {
      positions[i + 1] = 0;
      positions[i] = (Math.random() - 0.5) * 10;
      positions[i + 2] = (Math.random() - 0.5) * 10;
    }
  }
  
  particleSystem.geometry.attributes.position.needsUpdate = true;
}

// ========== å¢å¼ºåŠŸèƒ½ï¼šåœºæ™¯åˆ‡æ¢ ==========
function switchScene(sceneName) {
  currentScene = sceneName;
  
  switch(sceneName) {
    case 'default':
      if (directionalLight) directionalLight.color.setHex(0xffffff);
      if (ambientLight) ambientLight.color.setHex(0xffffff);
      if (particleSystem) particleSystem.visible = false;
      break;
      
    case 'night':
      if (directionalLight) {
        directionalLight.color.setHex(0x6699ff);
        directionalLight.intensity = 0.3;
      }
      if (ambientLight) {
        ambientLight.color.setHex(0x334466);
        ambientLight.intensity = 0.2;
      }
      if (particleSystem) particleSystem.visible = true;
      break;
      
    case 'sunset':
      if (directionalLight) {
        directionalLight.color.setHex(0xff9966);
        directionalLight.intensity = 0.6;
      }
      if (ambientLight) {
        ambientLight.color.setHex(0xffbb99);
        ambientLight.intensity = 0.3;
      }
      break;
      
    case 'warm':
      if (directionalLight) {
        directionalLight.color.setHex(0xffddaa);
        directionalLight.intensity = 0.8;
      }
      if (ambientLight) {
        ambientLight.color.setHex(0xffeedd);
        ambientLight.intensity = 0.4;
      }
      break;
  }
  
  addMsg("ç³»ç»Ÿ", `åœºæ™¯å·²åˆ‡æ¢: ${sceneName}`);
}

// ========== å¢å¼ºåŠŸèƒ½ï¼šå¿«æ·é”®ç³»ç»Ÿ ==========
function initKeyboardShortcuts() {
  document.addEventListener('keydown', (e) => {
    // æ„å»ºå¿«æ·é”®å­—ç¬¦ä¸²
    let shortcut = '';
    if (e.ctrlKey) shortcut += 'ctrl+';
    if (e.shiftKey) shortcut += 'shift+';
    if (e.altKey) shortcut += 'alt+';
    
    // ç‰¹æ®Šé”®
    if (e.key === ' ') shortcut += 'space';
    else if (e.key === 'Escape') shortcut += 'escape';
    else shortcut += e.key.toLowerCase();
    
    // æ‰§è¡Œå¿«æ·é”®å¯¹åº”çš„åŠŸèƒ½
    if (keyboardShortcuts[shortcut]) {
      e.preventDefault();
      keyboardShortcuts[shortcut]();
    }
  });
  
  console.log('å¿«æ·é”®ç³»ç»Ÿå·²åˆå§‹åŒ–');
  addMsg("ç³»ç»Ÿ", "ğŸ’¡ å¿«æ·é”®æç¤º: Ctrl+M=è¯­éŸ³, Ctrl+S=å¯¼å‡º, Ctrl+L=æ¸…ç©º, ESC=åœæ­¢");
}

// ========== å¢å¼ºåŠŸèƒ½ï¼šæ™ºèƒ½æ¶ˆæ¯å»ºè®® ==========
function suggestMessages() {
  const suggestions = [
    "ä½ å¥½å‘€ï¼",
    "ä»Šå¤©è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿ",
    "èƒ½ç»™æˆ‘è®²ä¸ªæ•…äº‹å—ï¼Ÿ",
    "ä½ æœ€å–œæ¬¢ä»€ä¹ˆï¼Ÿ",
    "æˆ‘ä»¬èŠç‚¹ä»€ä¹ˆå¥½å‘¢ï¼Ÿ",
    "èƒ½å¸®æˆ‘ä¸€ä¸ªå¿™å—ï¼Ÿ",
    "ä½ ä¼šåšä»€ä¹ˆï¼Ÿ",
    "ç»™æˆ‘æ¨èç‚¹ä»€ä¹ˆå§"
  ];
  
  return suggestions;
}

function showMessageSuggestions() {
  const suggestions = suggestMessages();
  const randomSuggestions = suggestions.sort(() => 0.5 - Math.random()).slice(0, 3);
  
  // åœ¨èŠå¤©æ¡†ä¸­æ˜¾ç¤ºå»ºè®®
  const suggestionsHTML = randomSuggestions.map(s => 
    `<button class="suggestion-btn" onclick="sendMessage('${s}')">${s}</button>`
  ).join('');
  
  addMsg("ç³»ç»Ÿ", `ğŸ’¡ ä½ å¯ä»¥è¯•è¯•: ${suggestionsHTML}`);
}

function updateProcedural(delta){ 
  if(!vrm) return; 
  updateBreathing(delta);
  updateBlinking(delta);
  updateTracking(delta);
  updateSpeakingAnimation(delta);
  updateIdleAnimation(delta);
  updateParticleSystem(delta); // å¢å¼ºï¼šç²’å­ç³»ç»Ÿæ›´æ–°
}

function animate(){ 
  requestAnimationFrame(animate); 
  const delta = clock.getDelta(); 
  
  // æ›´æ–°æ€§èƒ½ç»Ÿè®¡
  updatePerformanceStats();
  
  if(vrm){ 
    try{ 
      vrm.update(delta); 
    }catch(e){} 
    updateProcedural(delta); 
  } 
  renderer.render(scene, camera); 
}

function showLoading(s,txt){ 
  const loadingOverlay = document.getElementById('loading-overlay');
  if (loadingOverlay) {
    loadingOverlay.style.display = s ? 'flex' : 'none';
  }
  
  if(txt) {
    const loadingText = document.getElementById('loading-text');
    if (loadingText) {
      loadingText.innerText = txt;
    }
  }
}

// å‘é€æ¶ˆæ¯å‡½æ•°
function sendMessage(message) {
  if (!message.trim()) return;
  
  // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
  addMsg("ç”¨æˆ·", message);
  
  // å‘é€åˆ°AI
  sendMessageToAI(message);
}

function initEvents(){
  // è®¾ç½®é¢æ¿å¼€å…³
  document.getElementById('open-settings').addEventListener('click', ()=> {
    document.getElementById('settings-panel').classList.remove('settings-hidden');
  });
  document.getElementById('close-settings').addEventListener('click', ()=> {
    document.getElementById('settings-panel').classList.add('settings-hidden');
  });
  
  // VRMæ–‡ä»¶ä¸Šä¼ 
  document.getElementById('vrm-file-input').addEventListener('change', e => { 
    if(e.target.files.length>0) loadVRM(e.target.files[0]); 
  });
  
  // æ–°çš„æ§åˆ¶é¢æ¿ä¸­çš„VRMæ–‡ä»¶ä¸Šä¼ 
  const vrmFileInput = document.getElementById('vrm-file');
  if (vrmFileInput) {
    vrmFileInput.addEventListener('change', e => { 
      if(e.target.files.length>0) {
        loadVRM(e.target.files[0]);
        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        updateServiceStatus('vrm', 'connected', 'VRM æ¨¡å‹å·²åŠ è½½');
      }
    });
  }
  
  // æ¨¡å‹æ§åˆ¶äº‹ä»¶ç›‘å¬å™¨
  initModelControls();
  
  const drop = document.getElementById('vrm-drop-zone');
  drop.addEventListener('click', ()=> document.getElementById('vrm-file-input').click());
  drop.addEventListener('dragover', e => { e.preventDefault(); drop.classList.add('drop-zone-active'); });
  drop.addEventListener('dragleave', e => drop.classList.remove('drop-zone-active'));
  drop.addEventListener('drop', e => { 
    e.preventDefault(); 
    drop.classList.remove('drop-zone-active'); 
    if(e.dataTransfer.files.length>0) loadVRM(e.dataTransfer.files[0]); 
  });

  // ç¯å…‰è®¾ç½®
  document.getElementById('dir-light-intensity').addEventListener('input', e => directionalLight.intensity = parseFloat(e.target.value));
  document.getElementById('amb-light-intensity').addEventListener('input', e => ambientLight.intensity = parseFloat(e.target.value));
  document.getElementById('breath-intensity').addEventListener('input', e => breathIntensity = parseFloat(e.target.value));
  
  // çœ¨çœ¼åŠ¨ç”»è®¾ç½®
  document.getElementById('blink-interval').addEventListener('input', e => blinkInterval = parseFloat(e.target.value));
  document.getElementById('blink-speed').addEventListener('input', e => blinkSpeed = parseFloat(e.target.value));

  // åŠ¨ç”»æ§åˆ¶æŒ‰é’®
  document.getElementById('toggle-breathing').addEventListener('click', function(){ 
    breathingEnabled = !breathingEnabled; 
    this.textContent = `å‘¼å¸åŠ¨ç”»:${breathingEnabled ? 'å¼€' : 'å…³'}`; 
    this.className = breathingEnabled ? 'bg-blue-500' : 'bg-gray-500'; 
  });
  
  document.getElementById('toggle-blinking').addEventListener('click', function(){ 
    blinkingEnabled = !blinkingEnabled;
    this.textContent = `çœ¨çœ¼åŠ¨ç”»:${blinkingEnabled ? 'å¼€' : 'å…³'}`; 
    this.className = blinkingEnabled ? 'bg-green-500' : 'bg-gray-500';
    
    // é‡ç½®çœ¨çœ¼çŠ¶æ€
    if (blinkingEnabled) {
      blinkTimer = 0;
      isBlinking = false;
      setBlinkValue(0); // ç¡®ä¿çœ¼ç›çå¼€
    }
  });

  // èŠå¤©åŠŸèƒ½
  document.getElementById('send-message').addEventListener('click', ()=>{ 
    const input = document.getElementById('chat-input'); 
    if(input.value.trim()){ 
      sendMessage(input.value.trim());
      input.value=''; 
    } 
  });
  
  // å›è½¦å‘é€æ¶ˆæ¯
  document.getElementById('chat-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      document.getElementById('send-message').click();
    }
  });

  // è¯­éŸ³è¾“å…¥æŒ‰é’®
  document.getElementById('voice-input-btn').addEventListener('click', toggleVoice);
  document.getElementById('toggle-voice').addEventListener('click', toggleVoice);

  // æ¸…ç©ºå¯¹è¯æŒ‰é’®
  document.getElementById('clear-chat').addEventListener('click', function() {
    const chatMessages = document.getElementById('chat-messages');
    chatMessages.innerHTML = '';
    conversationHistory = [];
    localStorage.removeItem('ai-eva-conversation');
    addMsg("AIåŠ©æ‰‹", "å¯¹è¯å·²æ¸…ç©ºï¼Œå¼€å§‹æ–°çš„å¯¹è¯å§ï¼");
  });
  
  // SenseVoice åˆ‡æ¢æŒ‰é’®
  document.getElementById('toggle-sensevoice').addEventListener('click', function() {
    useSenseVoice = !useSenseVoice;
    const btn = document.getElementById('toggle-sensevoice');
    
    if (useSenseVoice) {
      btn.innerHTML = '<span class="material-icons-round">record_voice_over</span>è¯­éŸ³è¯†åˆ«:å¼€';
      btn.className = 'active';
      addMsg("ç³»ç»Ÿ", "å·²åˆ‡æ¢åˆ° SenseVoice è¯­éŸ³è¯†åˆ«æ¨¡å¼ï¼ˆæ›´å‡†ç¡®ï¼‰");
    } else {
      btn.innerHTML = '<span class="material-icons-round">record_voice_over</span>è¯­éŸ³è¯†åˆ«:å…³';
      btn.className = '';
      addMsg("ç³»ç»Ÿ", "å·²åˆ‡æ¢åˆ°æµè§ˆå™¨åŸç”Ÿè¯­éŸ³è¯†åˆ«æ¨¡å¼");
    }
  });
  
  // å¯¼å‡ºåŠŸèƒ½æŒ‰é’®
  document.getElementById('export-txt').addEventListener('click', () => exportConversation('txt'));
  document.getElementById('export-json').addEventListener('click', () => exportConversation('json'));
  
  document.getElementById('share-btn').addEventListener('click', shareDemo);
  
  document.getElementById('skip-tutorial').addEventListener('click', () => {
    document.getElementById('tutorial-overlay').style.display = 'none';
    localStorage.setItem('ai-eva-tutorial-skipped', 'true');
  });
  
  document.getElementById('start-tutorial').addEventListener('click', () => {
    document.getElementById('tutorial-overlay').style.display = 'none';
    startTutorial();
  });
  
æŒ‰é’®
  document.getElementById('clear-performance').addEventListener('click', function() {
    performanceStats.apiResponseTime = {};
    performanceStats.frameCount = 0;
    performanceStats.lastFpsUpdate = Date.now();
    addMsg("ç³»ç»Ÿ", "æ€§èƒ½ç»Ÿè®¡å·²æ¸…ç©º");
  });
  
  document.getElementById('toggle-performance').addEventListener('click', function() {
    const panel = document.getElementById('performance-panel');
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
  });

  // Ollamaè®¾ç½®æ›´æ–°
  document.getElementById('ollama-url').addEventListener('change', function() {
    ollamaUrl = this.value;
    initOllamaConnection();
  });
  
  document.getElementById('ollama-model').addEventListener('change', function() {
    ollamaModel = this.value;
    conversationHistory = []; // æ¸…ç©ºå†å²è®°å½•
    addMsg("ç³»ç»Ÿ", `å·²åˆ‡æ¢åˆ°æ¨¡å‹: ${ollamaModel}`);
  });
  
  // æµ‹è¯•è¿æ¥æŒ‰é’®
  const testConnectionBtn = document.getElementById('test-connection');
  if (testConnectionBtn) {
    testConnectionBtn.addEventListener('click', initOllamaConnection);
  }

  // æˆªå›¾åŠŸèƒ½
  const screenshotBtn = document.getElementById('screenshot-btn');
  if (screenshotBtn) {
    screenshotBtn.addEventListener('click', ()=>{
    try{
      const dataURL = renderer.domElement.toDataURL('image/png');
      const a = document.createElement('a'); a.href = dataURL; a.download = 'vrm_screenshot.png'; document.body.appendChild(a); a.click(); a.remove();
    }catch(e){ console.warn('æˆªå›¾å¤±è´¥', e); }
  });
  }

  // é‡ç½®ä½ç½®åŠæ¢å¤éª¨éª¼åˆå§‹æ—‹è½¬
  const resetPositionBtn = document.getElementById('reset-position-btn');
  if (resetPositionBtn) {
    resetPositionBtn.addEventListener('click', ()=>{
    if(vrm && vrm.scene) vrm.scene.position.set(0,0,0);
    
    // é‡ç½®åˆ°åˆå§‹çŠ¶æ€è€Œä¸æ˜¯åŸå§‹çŠ¶æ€
    for(const k in bones){ 
      if(bones[k] && restPositions[k]) bones[k].position.copy(restPositions[k]); 
      if(bones[k] && restRotations[k]) {
        // é‡ç½®åˆ°åˆå§‹çŠ¶æ€ï¼ˆåŒ…å«INITIAL_POSEçš„åç§»ï¼‰
        bones[k].rotation.copy(restRotations[k]);
      } 
    }
    
    // é‡ç½®æ‰€æœ‰éª¨éª¼æ§åˆ¶æ»‘å—
    const sliders = document.querySelectorAll('#bone-controls input[type="range"]');
    sliders.forEach(slider => {
      slider.value = 0;
    });
    
    // é‡ç½®æŒ‰é’®çŠ¶æ€
    const buttons = document.querySelectorAll('#bone-controls .button-group button');
    buttons.forEach(button => {
      button.classList.remove('active');
      if (button.dataset.preset === 'natural') {
        button.classList.add('active');
      }
    });
    
    // é‡ç½®çœ¨çœ¼çŠ¶æ€
    blinkingEnabled = true;
    document.getElementById('toggle-blinking').textContent = 'çœ¨çœ¼åŠ¨ç”»:å¼€';
    document.getElementById('toggle-blinking').className = 'bg-green-500';
    blinkTimer = 0;
    isBlinking = false;
    setBlinkValue(0);
    
    // é‡ç½®è¿½è¸ªçŠ¶æ€
    headTrackingEnabled = true;
    eyeTrackingEnabled = true;
    document.getElementById('toggle-head-tracking').textContent = 'å¤´éƒ¨è¿½è¸ª:å¼€';
    document.getElementById('toggle-head-tracking').className = 'bg-purple-500';
    document.getElementById('toggle-eye-tracking').textContent = 'çœ¼ç›è¿½è¸ª:å¼€';
    document.getElementById('toggle-eye-tracking').className = 'bg-indigo-500';
    
    // é‡ç½®é¼ æ ‡ä½ç½®
    mouseX = 0;
    mouseY = 0;
  });
  }

  // æ‹–æ”¾å…¨å±€æ”¯æŒï¼ˆé¡µé¢ä»»æ„ä½ç½®ï¼‰
  window.addEventListener('dragover', e => { e.preventDefault(); }, false);
  window.addEventListener('drop', e => { 
    e.preventDefault(); 
    const f = e.dataTransfer.files && e.dataTransfer.files[0]; 
    if(f && f.name.toLowerCase().endsWith('.vrm')) loadVRM(f); 
    else console.warn('ä»…æ”¯æŒ .vrm æ–‡ä»¶'); 
  }, false);

  // çª—å£å˜æ›´
  window.addEventListener('resize', ()=>{ 
    if(camera && renderer){ 
      camera.aspect = window.innerWidth / window.innerHeight; 
      camera.updateProjectionMatrix(); 
      renderer.setSize(window.innerWidth, window.innerHeight); 
    } 
  });
}

function addMsg(sender, text, saveToHistory = true){ 
  const box = document.getElementById('chat-messages'); 
  const messageContainer = document.createElement('div'); 
  
  if(sender === 'ç”¨æˆ·'){ 
    messageContainer.className = 'message-container user-message';
    const bubble = document.createElement('div');
    bubble.className = 'message-bubble';
    bubble.textContent = text;
    messageContainer.appendChild(bubble);
  } else if (sender === 'AIåŠ©æ‰‹') {
    messageContainer.className = 'message-container ai-message';
    const bubble = document.createElement('div');
    bubble.className = 'message-bubble';
    bubble.textContent = text;
    messageContainer.appendChild(bubble);
  } else {
    messageContainer.className = 'message-container system-message';
    const bubble = document.createElement('div');
    bubble.className = 'message-bubble';
    bubble.innerHTML = text;
    messageContainer.appendChild(bubble);
  }
  
  box.appendChild(messageContainer); 
  box.scrollTop = box.scrollHeight; 
}

// å®æ—¶çŠ¶æ€æ›´æ–°å‡½æ•°
function updateServiceStatus(service, status, message = '') {
  const indicator = document.getElementById(`${service}-indicator`);
  const text = document.getElementById(`${service}-text`);
  
  if (indicator && text) {
    // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
    indicator.classList.remove('connected', 'connecting', 'disconnected');
    
    switch (status) {
      case 'connected':
        indicator.classList.add('connected');
        text.textContent = message || `${service} å·²è¿æ¥`;
        
        // å¦‚æœæ˜¯ Ollama è¿æ¥æˆåŠŸï¼Œæ˜¾ç¤ºæ¨¡å‹é€‰æ‹©å™¨å¹¶è·å–æ¨¡å‹åˆ—è¡¨
        if (service === 'ollama') {
          const modelSelector = document.getElementById('model-selector');
          if (modelSelector) {
            modelSelector.style.display = 'block';
            modelSelector.style.animation = 'slideDown 0.4s ease-out';
            // åŠ¨ç”»ç»“æŸåç§»é™¤åŠ¨ç”»ç±»
            setTimeout(() => {
              modelSelector.style.animation = '';
            }, 400);
          }
          
          // è·å–æ¨¡å‹åˆ—è¡¨
          fetchOllamaModels();
        }
        break;
      case 'connecting':
        indicator.classList.add('connecting');
        text.textContent = message || `${service} è¿æ¥ä¸­...`;
        break;
      case 'disconnected':
        indicator.classList.add('disconnected');
        text.textContent = message || `${service} æœªè¿æ¥`;
        
        // å¦‚æœæ˜¯ Ollama æ–­å¼€è¿æ¥ï¼Œéšè—æ¨¡å‹é€‰æ‹©å™¨
        if (service === 'ollama') {
          const modelSelector = document.getElementById('model-selector');
          if (modelSelector) {
            modelSelector.style.animation = 'slideUp 0.3s ease-in';
            setTimeout(() => {
              modelSelector.style.display = 'none';
              modelSelector.style.animation = '';
            }, 300);
          }
        }
        break;
      case 'error':
        indicator.classList.add('disconnected');
        text.textContent = message || `${service} è¿æ¥é”™è¯¯`;
        
        // å¦‚æœæ˜¯ Ollama è¿æ¥é”™è¯¯ï¼Œéšè—æ¨¡å‹é€‰æ‹©å™¨
        if (service === 'ollama') {
          const modelSelector = document.getElementById('model-selector');
          if (modelSelector) {
            modelSelector.style.animation = 'slideUp 0.3s ease-in';
            setTimeout(() => {
              modelSelector.style.display = 'none';
              modelSelector.style.animation = '';
            }, 300);
          }
        }
        break;
    }
  }
}

// è·å–Ollamaæ¨¡å‹åˆ—è¡¨
async function fetchOllamaModels() {
  try {
    const response = await fetch(`${OLLAMA_API}/api/tags`, {
      method: 'GET',
      timeout: 5000
    });
    
    if (response.ok) {
      const data = await response.json();
      const models = data.models || [];
      
      // æ›´æ–°æ¨¡å‹é€‰æ‹©å™¨
      const modelSelect = document.getElementById('ollama-model');
      if (modelSelect) {
        // æ¸…ç©ºç°æœ‰é€‰é¡¹
        modelSelect.innerHTML = '';
        
        if (models.length > 0) {
          // æ·»åŠ æ¨¡å‹é€‰é¡¹
          models.forEach(model => {
            const option = document.createElement('option');
            option.value = model.name;
            option.textContent = `${model.name} (${formatModelSize(model.size)})`;
            modelSelect.appendChild(option);
          });
          
          // è®¾ç½®é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªæ¨¡å‹
          if (models.length > 0) {
            modelSelect.value = models[0].name;
          }
        } else {
          // æ²¡æœ‰æ¨¡å‹æ—¶æ˜¾ç¤ºæç¤º
          const option = document.createElement('option');
          option.value = '';
          option.textContent = 'æœªæ‰¾åˆ°å¯ç”¨æ¨¡å‹';
          modelSelect.appendChild(option);
        }
      }
      
      return true;
    } else {
      throw new Error('Failed to fetch models');
    }
  } catch (error) {
    console.error('è·å–Ollamaæ¨¡å‹å¤±è´¥:', error);
    
    // æ›´æ–°æ¨¡å‹é€‰æ‹©å™¨æ˜¾ç¤ºé”™è¯¯
    const modelSelect = document.getElementById('ollama-model');
    if (modelSelect) {
      modelSelect.innerHTML = '<option value="">è·å–æ¨¡å‹å¤±è´¥</option>';
    }
    
    return false;
  }
}

// æ ¼å¼åŒ–æ¨¡å‹å¤§å°
function formatModelSize(bytes) {
  if (!bytes) return 'æœªçŸ¥å¤§å°';
  
  const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
  const i = Math.floor(Math.log(bytes) / Math.log(1024));
  return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
}

// å®æ—¶ç›‘æ§æœåŠ¡çŠ¶æ€
async function monitorServices() {
  // æ£€æŸ¥ Ollama çŠ¶æ€
  try {
    updateServiceStatus('ollama', 'connecting');
    const response = await fetch(`${OLLAMA_API}/api/tags`, {
      method: 'GET',
      timeout: 3000
    });
    if (response.ok) {
      updateServiceStatus('ollama', 'connected', 'Ollama å·²è¿æ¥');
      // è¿æ¥æˆåŠŸæ—¶è·å–æ¨¡å‹åˆ—è¡¨
      await fetchOllamaModels();
    } else {
      updateServiceStatus('ollama', 'disconnected', 'Ollama æœªå“åº”');
    }
  } catch (error) {
    updateServiceStatus('ollama', 'disconnected', 'Ollama æœªè¿æ¥');
  }
  
  // æ£€æŸ¥ ChatTTS çŠ¶æ€
  try {
    updateServiceStatus('tts', 'connecting');
    const response = await fetch(`${CHAT_TTS_API}/health`, {
      method: 'GET',
      timeout: 3000
    });
    if (response.ok) {
      updateServiceStatus('tts', 'connected', 'ChatTTS å·²è¿æ¥');
    } else {
      updateServiceStatus('tts', 'disconnected', 'ChatTTS æœªå“åº”');
    }
  } catch (error) {
    updateServiceStatus('tts', 'disconnected', 'ChatTTS æœªè¿æ¥');
  }
  
  // æ£€æŸ¥ SenseVoice çŠ¶æ€
  try {
    const response = await fetch(`${SENSEVOICE_API}/health`, {
      method: 'GET',
      timeout: 3000
    });
    if (response.ok) {
      updateServiceStatus('sensevoice', 'connected', 'SenseVoice å·²è¿æ¥');
    } else {
      updateServiceStatus('sensevoice', 'disconnected', 'SenseVoice æœªå“åº”');
    }
  } catch (error) {
    updateServiceStatus('sensevoice', 'disconnected', 'SenseVoice æœªè¿æ¥');
  }
}

// å¯åŠ¨å®æ—¶ç›‘æ§
function startServiceMonitoring() {
  // ç«‹å³æ£€æŸ¥ä¸€æ¬¡
  monitorServices();
  
  // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
  setInterval(monitorServices, 30000);
  
  // å½“ç”¨æˆ·è¿›è¡Œäº¤äº’æ—¶ä¹Ÿæ£€æŸ¥
  document.addEventListener('click', () => {
    setTimeout(monitorServices, 1000);
  });
}

// ç§»åŠ¨ç«¯æ§åˆ¶é¢æ¿åˆ‡æ¢
function initMobileControlPanel() {
  const toggleBtn = document.getElementById('toggle-control-panel');
  const controlPanel = document.querySelector('.control-panel');
  
  if (toggleBtn && controlPanel) {
    let isVisible = false;
    
    toggleBtn.addEventListener('click', () => {
      if (isVisible) {
        controlPanel.classList.add('hide');
        setTimeout(() => {
          controlPanel.classList.remove('show', 'hide');
          controlPanel.classList.add('hidden');
        }, 300);
        isVisible = false;
      } else {
        controlPanel.classList.remove('hidden', 'hide');
        controlPanel.classList.add('show');
        isVisible = true;
      }
    });
    
    // ç‚¹å‡»æ§åˆ¶é¢æ¿å¤–éƒ¨å…³é—­
    document.addEventListener('click', (e) => {
      if (isVisible && !controlPanel.contains(e.target) && !toggleBtn.contains(e.target)) {
        controlPanel.classList.add('hide');
        setTimeout(() => {
          controlPanel.classList.remove('show', 'hide');
          controlPanel.classList.add('hidden');
        }, 300);
        isVisible = false;
      }
    });
  }
}

// åˆå§‹åŒ–æ¨¡å‹åˆ·æ–°åŠŸèƒ½
function initModelRefresh() {
  const refreshBtn = document.getElementById('refresh-models');
  if (refreshBtn) {
    refreshBtn.addEventListener('click', async () => {
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      const modelSelect = document.getElementById('ollama-model');
      if (modelSelect) {
        modelSelect.innerHTML = '<option value="">æ­£åœ¨åˆ·æ–°æ¨¡å‹...</option>';
      }
      
      // æ·»åŠ æ—‹è½¬åŠ¨ç”»
      refreshBtn.style.animation = 'spin 1s linear infinite';
      
      try {
        await fetchOllamaModels();
      } catch (error) {
        console.error('åˆ·æ–°æ¨¡å‹å¤±è´¥:', error);
      } finally {
        // ç§»é™¤æ—‹è½¬åŠ¨ç”»
        refreshBtn.style.animation = '';
      }
    });
  }
}

// åˆå§‹åŒ–æ‰€æœ‰åŠŸèƒ½
// åˆå§‹åŒ–æ¨¡å‹æ§åˆ¶
function initModelControls() {
  if (!vrm) return;
  
  // ä½ç½®æ§åˆ¶
  const positionControls = ['model-x', 'model-y', 'model-z'];
  positionControls.forEach(id => {
    const slider = document.getElementById(id);
    const valueSpan = document.getElementById(id + '-value');
    if (slider && valueSpan) {
      slider.addEventListener('input', (e) => {
        const value = parseFloat(e.target.value);
        valueSpan.textContent = value.toFixed(1);
        
        if (vrm && vrm.scene) {
          if (id === 'model-x') vrm.scene.position.x = value;
          else if (id === 'model-y') vrm.scene.position.y = value;
          else if (id === 'model-z') vrm.scene.position.z = value;
        }
      });
    }
  });
  
  // æ—‹è½¬æ§åˆ¶
  const rotationControls = ['model-rotation-x', 'model-rotation-y', 'model-rotation-z'];
  rotationControls.forEach(id => {
    const slider = document.getElementById(id);
    const valueSpan = document.getElementById(id + '-value');
    if (slider && valueSpan) {
      slider.addEventListener('input', (e) => {
        const value = parseFloat(e.target.value);
        valueSpan.textContent = value + 'Â°';
        
        if (vrm && vrm.scene) {
          const radians = value * Math.PI / 180;
          if (id === 'model-rotation-x') vrm.scene.rotation.x = radians;
          else if (id === 'model-rotation-y') vrm.scene.rotation.y = radians;
          else if (id === 'model-rotation-z') vrm.scene.rotation.z = radians;
        }
      });
    }
  });
  
  // ç¼©æ”¾æ§åˆ¶
  const scaleSlider = document.getElementById('model-scale');
  const scaleValue = document.getElementById('model-scale-value');
  if (scaleSlider && scaleValue) {
    scaleSlider.addEventListener('input', (e) => {
      const value = parseFloat(e.target.value);
      scaleValue.textContent = value.toFixed(1);
      
      if (vrm && vrm.scene) {
        vrm.scene.scale.setScalar(value);
      }
    });
  }
  
  // é‡ç½®ä½ç½®æŒ‰é’®
  const resetBtn = document.getElementById('reset-model-position');
  if (resetBtn) {
    resetBtn.addEventListener('click', () => {
      if (vrm && vrm.scene) {
        vrm.scene.position.set(0, 0, 0);
        vrm.scene.rotation.set(0, 0, 0);
        vrm.scene.scale.setScalar(1);
        
        // é‡ç½®æ»‘å—å€¼
        document.getElementById('model-x').value = 0;
        document.getElementById('model-y').value = 0;
        document.getElementById('model-z').value = 0;
        document.getElementById('model-rotation-x').value = 0;
        document.getElementById('model-rotation-y').value = 0;
        document.getElementById('model-rotation-z').value = 0;
        document.getElementById('model-scale').value = 1;
        
        // æ›´æ–°æ˜¾ç¤ºå€¼
        document.getElementById('model-x-value').textContent = '0';
        document.getElementById('model-y-value').textContent = '0';
        document.getElementById('model-z-value').textContent = '0';
        document.getElementById('model-rotation-x-value').textContent = '0Â°';
        document.getElementById('model-rotation-y-value').textContent = '0Â°';
        document.getElementById('model-rotation-z-value').textContent = '0Â°';
        document.getElementById('model-scale-value').textContent = '1.0';
      }
    });
  }
  
  // å±…ä¸­æ˜¾ç¤ºæŒ‰é’®
  const centerBtn = document.getElementById('center-model');
  if (centerBtn) {
    centerBtn.addEventListener('click', () => {
      if (vrm && vrm.scene) {
        vrm.scene.position.set(0, 0, 0);
        vrm.scene.rotation.set(0, 0, 0); // é¢å‘ç›¸æœº
        
        // é‡ç½®ç›¸æœºä½ç½®ï¼Œç¡®ä¿æ¨¡å‹å±…ä¸­
        camera.position.set(0, 1.3, 2);
        camera.lookAt(0, 1.2, 0);
        controls.target.set(0, 1.2, 0);
        controls.update();
        
        // é‡ç½®æ»‘å—å€¼
        document.getElementById('model-x').value = 0;
        document.getElementById('model-y').value = 0;
        document.getElementById('model-z').value = 0;
        document.getElementById('model-rotation-x').value = 0;
        document.getElementById('model-rotation-y').value = 0; // Yè½´æ—‹è½¬0åº¦
        document.getElementById('model-rotation-z').value = 0;
        
        // æ›´æ–°æ˜¾ç¤ºå€¼
        document.getElementById('model-x-value').textContent = '0';
        document.getElementById('model-y-value').textContent = '0';
        document.getElementById('model-z-value').textContent = '0';
        document.getElementById('model-rotation-x-value').textContent = '0Â°';
        document.getElementById('model-rotation-y-value').textContent = '0Â°';
        document.getElementById('model-rotation-z-value').textContent = '0Â°';
      }
    });
  }
  
  // åŠ¨ä½œæ§åˆ¶æŒ‰é’®
  const actionButtons = [
    { id: 'play-wave', action: 'wave' },
    { id: 'play-nod', action: 'nod' },
    { id: 'play-shake', action: 'shake' },
    { id: 'play-point', action: 'point' }
  ];
  
  actionButtons.forEach(({ id, action }) => {
    const btn = document.getElementById(id);
    if (btn) {
      btn.addEventListener('click', () => {
        if (vrm) {
          playGesture(action);
        }
      });
    }
  });
  
  // è¡¨æƒ…æ§åˆ¶
  const expressionControls = ['expression-happy', 'expression-angry', 'expression-sad', 'expression-surprised'];
  expressionControls.forEach(id => {
    const slider = document.getElementById(id);
    const valueSpan = document.getElementById(id + '-value');
    if (slider && valueSpan) {
      slider.addEventListener('input', (e) => {
        const value = parseFloat(e.target.value);
        valueSpan.textContent = value.toFixed(1);
        
        if (vrm && vrm.expressionManager) {
          const expressionName = id.replace('expression-', '');
          vrm.expressionManager.setValue(expressionName, value);
        }
      });
    }
  });
}

async function initAll() {
  initScene(); 
  initEvents();
  
  // åˆå§‹åŒ–APIè®¾ç½®
  initApiSettings();
  
  initChatTTSControls();
  
  // åŠ è½½å¯¹è¯å†å²
  loadConversationHistory();
  
  // æ£€æŸ¥æ•™ç¨‹
  checkTutorial();
  
  // ========== å¢å¼ºåŠŸèƒ½åˆå§‹åŒ– ==========
  // åˆå§‹åŒ–éŸ³æ•ˆç³»ç»Ÿ
  initAudioSystem();
  
  // åˆå§‹åŒ–ç²’å­ç³»ç»Ÿ
  initParticleSystem();
  
  // åˆå§‹åŒ–å¿«æ·é”®
  initKeyboardShortcuts();
  
  // å¯åŠ¨å®æ—¶çŠ¶æ€ç›‘æ§
  startServiceMonitoring();
  
  // åˆå§‹åŒ–ç§»åŠ¨ç«¯æ§åˆ¶é¢æ¿
  initMobileControlPanel();
  
  // åˆå§‹åŒ–æ¨¡å‹åˆ·æ–°åŠŸèƒ½
  initModelRefresh();
  
  // æ˜¾ç¤ºæ¶ˆæ¯å»ºè®®ï¼ˆé¦–æ¬¡ï¼‰
  setTimeout(() => {
    showMessageSuggestions();
  }, 3000);
  
  // æµ‹è¯•æ‰€æœ‰è¿æ¥
  await testAllConnections();
  
  await initOllamaConnection();
  
  // æ˜¾ç¤ºè¿æ¥çŠ¶æ€
  const ollamaConnected = await testOllamaConnection();
  const chatTtsConnected = await testChatTTSConnection();
  
  if (ollamaConnected && chatTtsConnected) {
    addMsg("ç³»ç»Ÿ", "ğŸ‰ ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼AIå¯¹è¯å’Œè¯­éŸ³åŠŸèƒ½å·²å°±ç»ª");
    addMsg("ç³»ç»Ÿ", "ğŸ’¡ è¯•è¯•è¯´: \"ä½ å¥½\" æˆ–ä½¿ç”¨å¿«æ·é”® Ctrl+M å¼€å¯è¯­éŸ³");
  } else if (ollamaConnected) {
    addMsg("ç³»ç»Ÿ", "âš ï¸ ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼AIå¯¹è¯å·²å°±ç»ªï¼Œè¯­éŸ³åŠŸèƒ½æœªè¿æ¥");
  } else if (chatTtsConnected) {
    addMsg("ç³»ç»Ÿ", "âš ï¸ ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼è¯­éŸ³åŠŸèƒ½å·²å°±ç»ªï¼ŒAIå¯¹è¯æœªè¿æ¥");
  } else {
    addMsg("ç³»ç»Ÿ", "âŒ ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼è¯·æ£€æŸ¥AIå’Œè¯­éŸ³æœåŠ¡å™¨è¿æ¥");
  }
  
  // æ˜¾ç¤ºå¢å¼ºåŠŸèƒ½æç¤º
  setTimeout(() => {
    addMsg("ç³»ç»Ÿ", "âœ¨ æ–°åŠŸèƒ½: å¤šè§’è‰²åˆ‡æ¢ã€åœºæ™¯æ°›å›´ã€å¯¹è¯åˆ†æç­‰åŠŸèƒ½å·²å¯ç”¨ï¼");
  }, 5000);
}

// å¯åŠ¨
initAll();
</script>
</body>
</html>