<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI-EVA å¯åŠ¨å™¨</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 800px;
      width: 100%;
      padding: 40px;
    }

    h1 {
      text-align: center;
      color: #667eea;
      margin-bottom: 30px;
      font-size: 2.5em;
    }

    .status-section {
      margin-bottom: 30px;
    }

    .status-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      margin-bottom: 10px;
      background: #f5f5f5;
      border-radius: 10px;
      transition: all 0.3s;
    }

    .status-item:hover {
      background: #e8e8e8;
      cursor: pointer;
    }

    .status-item.checking {
      background: #d1ecf1;
    }

    .status-label {
      font-weight: 600;
      color: #555;
    }

    .status-value {
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.9em;
      font-weight: 500;
    }

    .status-value.pending {
      background: #fff3cd;
      color: #856404;
    }

    .status-value.downloading {
      background: #d1ecf1;
      color: #0c5460;
    }

    .status-value.completed {
      background: #d4edda;
      color: #155724;
    }

    .status-value.error {
      background: #f8d7da;
      color: #721c24;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 10px;
      display: none;
    }

    .progress-bar.active {
      display: block;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      width: 0%;
      transition: width 0.3s;
    }

    .button-group {
      display: flex;
      gap: 15px;
      margin-top: 30px;
    }

    button {
      flex: 1;
      padding: 15px 30px;
      border: none;
      border-radius: 10px;
      font-size: 1.1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      color: white;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: #6c757d;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .log-container {
      margin-top: 30px;
      max-height: 300px;
      overflow-y: auto;
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 10px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 0.9em;
      display: none;
    }

    .log-container.active {
      display: block;
    }

    .log-line {
      margin-bottom: 5px;
      line-height: 1.5;
    }

    .log-line.info {
      color: #4ec9b0;
    }

    .log-line.error {
      color: #f48771;
    }

    .log-line.success {
      color: #4fc1ff;
    }

    .config-section {
      margin-top: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
    }

    .config-item {
      margin-bottom: 15px;
    }

    .config-item label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #555;
    }

    .config-item input {
      width: 100%;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 5px;
      font-size: 1em;
    }

    .config-item input:focus {
      outline: none;
      border-color: #667eea;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸš€ AI-EVA å¯åŠ¨å™¨</h1>

    <div class="config-section">
      <div class="config-item">
        <label>GitHub ä»“åº“:</label>
        <input type="text" value="https://github.com/AsZer0s/AI-EVA" readonly style="background: #f0f0f0; cursor: not-allowed;">
      </div>
      <div class="config-item">
        <label for="install-path">å®‰è£…è·¯å¾„:</label>
        <div style="display: flex; gap: 10px; align-items: center;">
          <input type="text" id="install-path" placeholder="C:\AI-EVA" value="" style="flex: 1;">
          <button id="btn-browse-path" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; white-space: nowrap;">æµè§ˆ</button>
        </div>
      </div>
    </div>

    <div class="status-section">
      <div class="status-item">
        <span class="status-label">ğŸ Python ç¯å¢ƒ</span>
        <span class="status-value pending" id="status-python">æœªæ£€æŸ¥</span>
      </div>
      <div class="progress-bar" id="progress-python">
        <div class="progress-fill" id="progress-fill-python"></div>
      </div>

      <div class="status-item">
        <span class="status-label">ğŸ“¦ AI-EVA é¡¹ç›®</span>
        <span class="status-value pending" id="status-ai-eva">æœªä¸‹è½½</span>
      </div>
      <div class="progress-bar" id="progress-ai-eva">
        <div class="progress-fill" id="progress-fill-ai-eva"></div>
      </div>

      <div class="status-item">
        <span class="status-label">ğŸµ IndexTTS2</span>
        <span class="status-value pending" id="status-indextts">æœªä¸‹è½½</span>
      </div>
      <div class="progress-bar" id="progress-indextts">
        <div class="progress-fill" id="progress-fill-indextts"></div>
      </div>
    </div>

    <div class="button-group">
      <button class="btn-primary" id="btn-download">å¼€å§‹ä¸‹è½½</button>
      <button class="btn-secondary" id="btn-launch" disabled>å¯åŠ¨ AI-EVA</button>
      <button class="btn-secondary" id="btn-check-gpu" disabled>æ£€æŸ¥ GPU</button>
    </div>

    <div class="log-container" id="log-container">
      <div class="log-line info">ç­‰å¾…å¼€å§‹...</div>
    </div>
  </div>

  <script type="module">
    import { invoke } from '@tauri-apps/api/tauri';
    import { open } from '@tauri-apps/api/dialog';

    const installPathInput = document.getElementById('install-path');
    const btnBrowsePath = document.getElementById('btn-browse-path');
    const btnDownload = document.getElementById('btn-download');
    const btnLaunch = document.getElementById('btn-launch');
    const logContainer = document.getElementById('log-container');
    const statusAiEva = document.getElementById('status-ai-eva');
    const statusIndexTTS = document.getElementById('status-indextts');
    const progressAiEva = document.getElementById('progress-ai-eva');
    const progressIndexTTS = document.getElementById('progress-indextts');
    const progressFillAiEva = document.getElementById('progress-fill-ai-eva');
    const progressFillIndexTTS = document.getElementById('progress-fill-indextts');
    const statusPython = document.getElementById('status-python');
    const progressPython = document.getElementById('progress-python');
    const progressFillPython = document.getElementById('progress-fill-python');

    function addLog(message, type = 'info') {
      const logLine = document.createElement('div');
      logLine.className = `log-line ${type}`;
      logLine.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logContainer.appendChild(logLine);
      logContainer.scrollTop = logContainer.scrollHeight;
      logContainer.classList.add('active');
    }

    function updateStatus(element, status, text) {
      element.className = `status-value ${status}`;
      element.textContent = text;
    }

    function updateProgress(progressBar, progressFill, percent) {
      progressBar.classList.add('active');
      progressFill.style.width = `${percent}%`;
    }

    // åˆå§‹åŒ–ï¼šè·å–é»˜è®¤å®‰è£…è·¯å¾„
    invoke('get_default_install_path').then(path => {
      if (!installPathInput.value) {
        installPathInput.value = path;
      }
    }).catch(err => {
      console.error('è·å–é»˜è®¤è·¯å¾„å¤±è´¥:', err);
    });

    // ç‚¹å‡»æµè§ˆæŒ‰é’®æ—¶æ‰“å¼€æ–‡ä»¶å¤¹é€‰æ‹©å¯¹è¯æ¡†
    btnBrowsePath.addEventListener('click', async () => {
      try {
        const selected = await open({
          directory: true,
          multiple: false,
          title: 'é€‰æ‹©å®‰è£…è·¯å¾„',
          defaultPath: installPathInput.value || undefined
        });

        if (selected && typeof selected === 'string') {
          installPathInput.value = selected;
          addLog(`å·²é€‰æ‹©å®‰è£…è·¯å¾„: ${selected}`, 'success');
        } else if (selected === null) {
          // ç”¨æˆ·å–æ¶ˆäº†é€‰æ‹©
          addLog('å·²å–æ¶ˆé€‰æ‹©è·¯å¾„', 'info');
        }
      } catch (error) {
        console.error('é€‰æ‹©è·¯å¾„å¤±è´¥:', error);
        addLog(`é€‰æ‹©è·¯å¾„å¤±è´¥: ${error}`, 'error');
      }
    });

    // ç‚¹å‡»è¾“å…¥æ¡†æ—¶ä¹Ÿæ‰“å¼€æ–‡ä»¶å¤¹é€‰æ‹©å¯¹è¯æ¡†
    installPathInput.addEventListener('click', async () => {
      btnBrowsePath.click();
    });

    // æ”¯æŒæ‰‹åŠ¨è¾“å…¥åéªŒè¯è·¯å¾„
    installPathInput.addEventListener('blur', () => {
      const path = installPathInput.value.trim();
      if (path) {
        addLog(`å®‰è£…è·¯å¾„å·²è®¾ç½®: ${path}`, 'info');
      }
    });

    // GitHub ä»“åº“åœ°å€ï¼ˆç¡¬ç¼–ç ï¼‰
    const GITHUB_REPO = 'https://github.com/AsZer0s/AI-EVA';

    // ä¸ºçŠ¶æ€é¡¹æ·»åŠ ç‚¹å‡»æ£€æŸ¥åŠŸèƒ½
    const statusItems = {
      python: {
        element: document.querySelector('.status-item:nth-child(1)'),
        statusElement: statusPython,
        checkFn: async () => {
          const installPath = installPathInput.value.trim();
          if (!installPath) {
            alert('è¯·å…ˆè¾“å…¥å®‰è£…è·¯å¾„ï¼');
            return;
          }
          return await invoke('check_python_env', { installPath: installPath });
        }
      },
      aiEva: {
        element: document.querySelector('.status-item:nth-child(3)'),
        statusElement: statusAiEva,
        checkFn: async () => {
          const installPath = installPathInput.value.trim();
          if (!installPath) {
            alert('è¯·å…ˆè¾“å…¥å®‰è£…è·¯å¾„ï¼');
            return;
          }
          return await invoke('check_ai_eva', { installPath: installPath });
        }
      },
      indexTTS: {
        element: document.querySelector('.status-item:nth-child(5)'),
        statusElement: statusIndexTTS,
        checkFn: async () => {
          const installPath = installPathInput.value.trim();
          if (!installPath) {
            alert('è¯·å…ˆè¾“å…¥å®‰è£…è·¯å¾„ï¼');
            return;
          }
          return await invoke('check_indextts', { installPath: installPath });
        }
      }
    };

    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
    Object.values(statusItems).forEach(item => {
      item.element.addEventListener('click', async () => {
        if (item.element.classList.contains('checking')) {
          return; // æ­£åœ¨æ£€æŸ¥ä¸­ï¼Œå¿½ç•¥ç‚¹å‡»
        }

        item.element.classList.add('checking');
        updateStatus(item.statusElement, 'downloading', 'æ£€æŸ¥ä¸­...');
        addLog(`å¼€å§‹æ£€æŸ¥ ${item.element.querySelector('.status-label').textContent.trim()}...`, 'info');

        try {
          const result = await item.checkFn();
          updateStatus(item.statusElement, 'completed', result || 'å·²å°±ç»ª');
          addLog(`${item.element.querySelector('.status-label').textContent.trim()}: ${result || 'æ£€æŸ¥å®Œæˆ'}`, 'success');
        } catch (error) {
          updateStatus(item.statusElement, 'error', 'æœªå®‰è£…');
          addLog(`æ£€æŸ¥å¤±è´¥: ${error}`, 'error');
        } finally {
          item.element.classList.remove('checking');
        }
      });
    });

    btnDownload.addEventListener('click', async () => {
      const installPath = installPathInput.value.trim();

      if (!installPath) {
        alert('è¯·è¾“å…¥å®‰è£…è·¯å¾„ï¼');
        return;
      }

      btnDownload.disabled = true;
      addLog('å¼€å§‹å®‰è£…æµç¨‹...', 'info');

      try {
        // 1. æ£€æŸ¥å¹¶å®‰è£… Python ç¯å¢ƒ
        updateStatus(statusPython, 'downloading', 'æ£€æŸ¥ä¸­...');
        progressPython.classList.add('active');

        addLog('æ£€æŸ¥ Python ç¯å¢ƒ...', 'info');
        
        const pythonResult = await invoke('setup_python_env', {
          installPath: installPath
        });

        updateStatus(statusPython, 'completed', 'å·²å°±ç»ª');
        progressFillPython.style.width = '100%';
        addLog(`Python ç¯å¢ƒ: ${pythonResult}`, 'success');

        // 2. ä¸‹è½½ AI-EVA
        updateStatus(statusAiEva, 'downloading', 'ä¸‹è½½ä¸­...');
        progressAiEva.classList.add('active');

        addLog(`å¼€å§‹ä¸‹è½½ AI-EVA ä»: ${GITHUB_REPO}`, 'info');
        
        await invoke('download_ai_eva', {
          repoUrl: GITHUB_REPO,
          installPath: installPath
        });

        updateStatus(statusAiEva, 'completed', 'å·²å®Œæˆ');
        progressFillAiEva.style.width = '100%';
        addLog('AI-EVA ä¸‹è½½å®Œæˆï¼', 'success');

        // å…‹éš† IndexTTS2
        updateStatus(statusIndexTTS, 'downloading', 'ä¸‹è½½ä¸­...');
        progressIndexTTS.classList.add('active');

        addLog('å¼€å§‹å…‹éš† IndexTTS2...', 'info');
        
        await invoke('clone_indextts2', {
          installPath: installPath
        });

        updateStatus(statusIndexTTS, 'completed', 'å·²å®Œæˆ');
        progressFillIndexTTS.style.width = '100%';
        addLog('IndexTTS2 å…‹éš†å®Œæˆï¼', 'success');

        btnLaunch.disabled = false;
        btnCheckGpu.disabled = false;
        addLog('æ‰€æœ‰èµ„æºä¸‹è½½å®Œæˆï¼å¯ä»¥å¯åŠ¨ AI-EVA äº†ã€‚', 'success');

      } catch (error) {
        addLog(`é”™è¯¯: ${error}`, 'error');
        updateStatus(statusPython, 'error', 'å¤±è´¥');
        updateStatus(statusAiEva, 'error', 'å¤±è´¥');
        updateStatus(statusIndexTTS, 'error', 'å¤±è´¥');
        alert(`å®‰è£…å¤±è´¥: ${error}`);
      } finally {
        btnDownload.disabled = false;
      }
    });

    btnLaunch.addEventListener('click', async () => {
      const installPath = installPathInput.value.trim();
      
      if (!installPath) {
        alert('è¯·è¾“å…¥å®‰è£…è·¯å¾„ï¼');
        return;
      }

      try {
        addLog('æ­£åœ¨å¯åŠ¨ AI-EVA...', 'info');
        await invoke('launch_ai_eva', {
          installPath: installPath
        });
        addLog('AI-EVA å¯åŠ¨æˆåŠŸï¼', 'success');
      } catch (error) {
        addLog(`å¯åŠ¨å¤±è´¥: ${error}`, 'error');
        alert(`å¯åŠ¨å¤±è´¥: ${error}`);
      }
    });

    btnCheckGpu.addEventListener('click', async () => {
      const installPath = installPathInput.value.trim();
      
      if (!installPath) {
        alert('è¯·è¾“å…¥å®‰è£…è·¯å¾„ï¼');
        return;
      }

      btnCheckGpu.disabled = true;
      addLog('æ­£åœ¨æ£€æŸ¥ GPU ç¯å¢ƒ...', 'info');

      try {
        const result = await invoke('check_gpu', {
          installPath: installPath
        });
        addLog(result, 'success');
        // æ˜¾ç¤ºç»“æœåœ¨å¼¹çª—ä¸­
        alert(result);
      } catch (error) {
        addLog(`GPU æ£€æŸ¥å¤±è´¥: ${error}`, 'error');
        alert(`GPU æ£€æŸ¥å¤±è´¥: ${error}`);
      } finally {
        btnCheckGpu.disabled = false;
      }
    });
  </script>
</body>
</html>

